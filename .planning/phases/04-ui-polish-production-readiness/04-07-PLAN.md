---
phase: 04-ui-polish-production-readiness
plan: 07
type: execute
wave: 4
depends_on: ["04-03", "04-04", "04-05", "04-06"]
files_modified:
  - frontend/src/pages/ContactsPage.tsx
  - frontend/src/components/messaging/ConversationList.tsx
  - frontend/src/components/call/ActiveCallWindow.tsx
  - frontend/src/components/call/IncomingCallBanner.tsx
autonomous: false

must_haves:
  truths:
    - "Pull-to-refresh works on conversation list"
    - "Pull-to-refresh works on contacts list"
    - "Mobile call UI is full-screen"
    - "App layout adapts to mobile screens"
  artifacts:
    - path: "frontend/src/components/messaging/ConversationList.tsx"
      provides: "Pull-to-refresh on conversation list"
      contains: "PullToRefresh"
    - path: "frontend/src/pages/ContactsPage.tsx"
      provides: "Pull-to-refresh on contacts"
      contains: "PullToRefresh"
  key_links:
    - from: "frontend/src/components/messaging/ConversationList.tsx"
      to: "react-simple-pull-to-refresh"
      via: "PullToRefresh wrapper"
      pattern: "PullToRefresh.*onRefresh"
---

<objective>
Add pull-to-refresh to lists, mobile-optimize call UI, and verify Phase 4 completion.

Purpose: Complete production polish with refresh gestures and mobile call experience.
Output: Pull-to-refresh on lists, full-screen mobile calls, and human verification of all Phase 4 features.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-ui-polish-production-readiness/04-CONTEXT.md
@frontend/src/pages/ContactsPage.tsx
@frontend/src/components/messaging/ConversationList.tsx
@frontend/src/components/call/ActiveCallWindow.tsx
@frontend/src/components/call/IncomingCallBanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pull-to-refresh to ConversationList</name>
  <files>frontend/src/components/messaging/ConversationList.tsx</files>
  <action>
    Wrap ConversationList content with PullToRefresh.

    Implementation:
    1. Import PullToRefresh from 'react-simple-pull-to-refresh'
    2. Add onRefresh prop to component interface
    3. Wrap list content with PullToRefresh component

    ```tsx
    import PullToRefresh from 'react-simple-pull-to-refresh'

    interface ConversationListProps {
      conversations: Conversation[]
      selectedId: string | null
      onSelect: (id: string) => void
      onRefresh?: () => Promise<void>  // New prop
    }

    export function ConversationList({
      conversations,
      selectedId,
      onSelect,
      onRefresh
    }: ConversationListProps) {
      const handleRefresh = async () => {
        if (onRefresh) await onRefresh()
      }

      const content = (
        <div className="divide-y">
          {conversations.map((conv) => (
            // ... existing conversation items
          ))}
        </div>
      )

      // Only wrap with pull-to-refresh if onRefresh provided
      if (!onRefresh) return content

      return (
        <PullToRefresh
          onRefresh={handleRefresh}
          pullingContent={<div className="text-center py-4 text-muted-foreground">Pull to refresh</div>}
          refreshingContent={<div className="text-center py-4 text-muted-foreground">Refreshing...</div>}
        >
          {content}
        </PullToRefresh>
      )
    }
    ```

    Update MessagesPage to pass onRefresh that reloads conversations.
  </action>
  <verify>TypeScript compiles: cd frontend && npx tsc --noEmit</verify>
  <done>ConversationList supports pull-to-refresh when onRefresh provided</done>
</task>

<task type="auto">
  <name>Task 2: Add pull-to-refresh to ContactsPage</name>
  <files>frontend/src/pages/ContactsPage.tsx</files>
  <action>
    Add pull-to-refresh to the contacts list section.

    Implementation:
    1. Import PullToRefresh from 'react-simple-pull-to-refresh'
    2. Wrap the contacts list with PullToRefresh
    3. onRefresh should reload contacts/friends list

    ```tsx
    import PullToRefresh from 'react-simple-pull-to-refresh'

    // In ContactsPage:
    const handleRefresh = async () => {
      // Reload friends/contacts
      await loadFriends()  // or whatever function loads contacts
    }

    return (
      <div className="h-full flex flex-col">
        <header>...</header>

        <PullToRefresh
          onRefresh={handleRefresh}
          pullingContent={<div className="text-center py-4">Pull to refresh</div>}
          refreshingContent={<div className="text-center py-4">Refreshing...</div>}
          className="flex-1 overflow-auto"
        >
          <div className="p-4">
            {/* Contacts list content */}
          </div>
        </PullToRefresh>
      </div>
    )
    ```
  </action>
  <verify>TypeScript compiles: cd frontend && npx tsc --noEmit</verify>
  <done>ContactsPage has pull-to-refresh on contacts list</done>
</task>

<task type="auto">
  <name>Task 3: Mobile-optimize call UI</name>
  <files>
    frontend/src/components/call/ActiveCallWindow.tsx
    frontend/src/components/call/IncomingCallBanner.tsx
  </files>
  <action>
    Update call components for mobile experience.

    From CONTEXT.md:
    - Active call: Full-screen by default on mobile, minimize option to floating window
    - Incoming call: Full-screen takeover on mobile (like native phone call)

    1. ActiveCallWindow.tsx:
       - Import useBreakpoint
       - On mobile (when not minimized): full-screen overlay
       - On desktop: current floating window behavior
       - Minimized: small floating window on both

    ```tsx
    const { isMobile } = useBreakpoint()

    // Full screen on mobile (unless minimized)
    if (isMobile && !isMinimized) {
      return (
        <div className="fixed inset-0 z-50 bg-background flex flex-col">
          {/* Full screen call UI */}
          <div className="flex-1 flex flex-col items-center justify-center">
            <Avatar ... className="h-24 w-24" />
            <h2 className="text-2xl mt-4">{remoteUsername}</h2>
            <CallTimer ... />
            <CallQualityIndicator ... />
          </div>
          <CallControls ... className="pb-8" />
        </div>
      )
    }

    // Desktop or minimized: existing floating window
    return (
      // ... existing implementation
    )
    ```

    2. IncomingCallBanner.tsx:
       - On mobile: full-screen takeover like native phone call
       - On desktop: current banner at top

    ```tsx
    const { isMobile } = useBreakpoint()

    if (isMobile) {
      return (
        <div className="fixed inset-0 z-50 bg-background flex flex-col items-center justify-center">
          <div className="text-center">
            <Avatar ... className="h-24 w-24 mx-auto" />
            <h2 className="text-2xl mt-4">{callerUsername}</h2>
            <p className="text-muted-foreground mt-2">Incoming call...</p>
          </div>
          <div className="flex gap-8 mt-12">
            <Button onClick={onReject} variant="destructive" size="lg" className="rounded-full h-16 w-16">
              <PhoneOff className="h-6 w-6" />
            </Button>
            <Button onClick={onAccept} size="lg" className="rounded-full h-16 w-16 bg-green-500 hover:bg-green-600">
              <Phone className="h-6 w-6" />
            </Button>
          </div>
        </div>
      )
    }

    // Desktop: existing banner
    return (
      // ... existing implementation
    )
    ```
  </action>
  <verify>cd frontend && npm run build</verify>
  <done>Call UI is full-screen on mobile, floating on desktop</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 4 UI Polish features</what-built>
  <how-to-verify>
    Test on both desktop and mobile (use browser dev tools mobile emulation):

    **Mobile Layout (resize to < 768px or use mobile emulator):**
    1. Bottom navigation appears (Messages, Contacts, Settings)
    2. Sidebar is hidden
    3. Tapping Messages shows conversation list full-width
    4. Selecting a conversation shows full-screen chat with back button
    5. Back button returns to conversation list

    **Loading States:**
    1. Navigate to Messages - should show skeleton while loading
    2. Navigate to Contacts - should show skeleton while loading

    **Error Handling:**
    1. Disconnect network briefly - should show "Connection lost" banner
    2. Reconnect - banner should disappear, may show "Connected" toast

    **Session Recovery (optional, harder to test):**
    1. If you can expire your session manually, verify modal appears
    2. Login should work without losing app state

    **Pull-to-Refresh (mobile):**
    1. On conversation list, pull down - should trigger refresh
    2. On contacts page, pull down - should trigger refresh

    **Call UI (mobile):**
    1. If possible, initiate a test call
    2. Incoming call should show full-screen
    3. Active call should show full-screen
  </how-to-verify>
  <resume-signal>Type "approved" if Phase 4 features work correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. cd frontend && npm run build
2. All Phase 4 success criteria manually verified
</verification>

<success_criteria>
All Phase 4 roadmap success criteria verified:
1. App layout adapts properly to mobile browser screens
2. App shows loading states during long operations
3. App handles network errors gracefully with user-friendly messages
4. User can recover from common error scenarios without refreshing
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-polish-production-readiness/04-07-SUMMARY.md`
</output>
