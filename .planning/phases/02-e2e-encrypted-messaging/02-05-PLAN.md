---
phase: 02-e2e-encrypted-messaging
plan: 05
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/components/messaging/MessageList.tsx
  - frontend/src/components/messaging/MessageInput.tsx
  - frontend/src/components/messaging/ConversationView.tsx
  - frontend/src/components/messaging/ConversationList.tsx
  - frontend/src/components/ui/avatar.tsx
  - frontend/src/components/ui/scroll-area.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of conversations in sidebar"
    - "User can select a conversation to view messages"
    - "User can type and send a message"
    - "Messages display with sender attribution and timestamps"
    - "Message input clears after sending"
  artifacts:
    - path: "frontend/src/components/messaging/MessageList.tsx"
      provides: "Scrollable message display"
      exports: "MessageList"
    - path: "frontend/src/components/messaging/MessageInput.tsx"
      provides: "Message composition input"
      exports: "MessageInput"
    - path: "frontend/src/components/messaging/ConversationView.tsx"
      provides: "Combined message list and input"
      exports: "ConversationView"
    - path: "frontend/src/components/messaging/ConversationList.tsx"
      provides: "List of conversations for sidebar"
      exports: "ConversationList"
  key_links:
    - from: "frontend/src/components/messaging/ConversationView.tsx"
      to: "frontend/src/components/messaging/MessageList.tsx"
      via: "import"
      pattern: "MessageList"
    - from: "frontend/src/components/messaging/ConversationView.tsx"
      to: "frontend/src/components/messaging/MessageInput.tsx"
      via: "import"
      pattern: "MessageInput"
---

<objective>
Create the messaging UI components: conversation list, message display, and message input.

Purpose: Provide the visual interface for users to see and send encrypted messages
Output: Reusable messaging components ready to be wired to state and WebSocket in Plan 06
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing codebase references
@frontend/src/components/ui/button.tsx
@frontend/src/components/ui/input.tsx
@frontend/src/components/ui/card.tsx
@frontend/src/components/layout/Sidebar.tsx
@frontend/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shadcn/ui Avatar and ScrollArea components</name>
  <files>frontend/src/components/ui/avatar.tsx, frontend/src/components/ui/scroll-area.tsx</files>
  <action>
Create two shadcn/ui components needed for messaging UI.

1. Create frontend/src/components/ui/avatar.tsx:

```typescript
import * as React from "react"
import { cn } from "@/lib/utils"

interface AvatarProps extends React.HTMLAttributes<HTMLDivElement> {
  src?: string;
  alt?: string;
  fallback?: string;
}

const Avatar = React.forwardRef<HTMLDivElement, AvatarProps>(
  ({ className, src, alt, fallback, ...props }, ref) => {
    const [hasError, setHasError] = React.useState(false);

    return (
      <div
        ref={ref}
        className={cn(
          "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
          className
        )}
        {...props}
      >
        {src && !hasError ? (
          <img
            src={src}
            alt={alt || "Avatar"}
            onError={() => setHasError(true)}
            className="aspect-square h-full w-full object-cover"
          />
        ) : (
          <div className="flex h-full w-full items-center justify-center rounded-full bg-muted text-sm font-medium uppercase">
            {fallback?.slice(0, 2) || "?"}
          </div>
        )}
      </div>
    )
  }
)
Avatar.displayName = "Avatar"

export { Avatar }
```

2. Create frontend/src/components/ui/scroll-area.tsx:

```typescript
import * as React from "react"
import { cn } from "@/lib/utils"

interface ScrollAreaProps extends React.HTMLAttributes<HTMLDivElement> {
  orientation?: "vertical" | "horizontal";
}

const ScrollArea = React.forwardRef<HTMLDivElement, ScrollAreaProps>(
  ({ className, children, orientation = "vertical", ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          "relative overflow-hidden",
          className
        )}
        {...props}
      >
        <div
          className={cn(
            "h-full w-full overflow-auto",
            orientation === "horizontal" && "overflow-x-auto overflow-y-hidden"
          )}
          style={{ scrollbarWidth: 'thin' }}
        >
          {children}
        </div>
      </div>
    )
  }
)
ScrollArea.displayName = "ScrollArea"

export { ScrollArea }
```

NOTE: These are simplified versions without Radix UI dependency. They provide the basic functionality needed for messaging UI.
  </action>
  <verify>npm run build compiles without errors</verify>
  <done>Avatar and ScrollArea components created with appropriate styling</done>
</task>

<task type="auto">
  <name>Task 2: Create MessageList and MessageInput components</name>
  <files>frontend/src/components/messaging/MessageList.tsx, frontend/src/components/messaging/MessageInput.tsx</files>
  <action>
1. Create frontend/src/components/messaging/MessageList.tsx:

```typescript
import * as React from 'react';
import { cn } from '@/lib/utils';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Avatar } from '@/components/ui/avatar';

interface Message {
  id: number;
  senderId: string;
  content: string;
  timestamp: Date;
  status: 'sending' | 'sent' | 'delivered' | 'read';
}

interface MessageListProps {
  messages: Message[];
  currentUserId: string;
  contactEmail?: string;
}

function formatTime(date: Date): string {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDate(date: Date): string {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  if (date.toDateString() === today.toDateString()) {
    return 'Today';
  } else if (date.toDateString() === yesterday.toDateString()) {
    return 'Yesterday';
  } else {
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
  }
}

export function MessageList({ messages, currentUserId, contactEmail }: MessageListProps) {
  const scrollRef = React.useRef<HTMLDivElement>(null);
  const endRef = React.useRef<HTMLDivElement>(null);

  // Scroll to bottom on new messages
  React.useEffect(() => {
    endRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages.length]);

  // Group messages by date
  const groupedMessages = React.useMemo(() => {
    const groups: { date: string; messages: Message[] }[] = [];
    let currentDate = '';

    for (const msg of messages) {
      const dateStr = formatDate(msg.timestamp);
      if (dateStr !== currentDate) {
        currentDate = dateStr;
        groups.push({ date: dateStr, messages: [msg] });
      } else {
        groups[groups.length - 1].messages.push(msg);
      }
    }

    return groups;
  }, [messages]);

  return (
    <ScrollArea className="flex-1 p-4" ref={scrollRef}>
      <div className="space-y-4">
        {groupedMessages.map((group) => (
          <div key={group.date}>
            <div className="flex justify-center my-4">
              <span className="text-xs text-muted-foreground bg-muted px-2 py-1 rounded">
                {group.date}
              </span>
            </div>
            <div className="space-y-2">
              {group.messages.map((message) => {
                const isOwn = message.senderId === currentUserId;
                return (
                  <div
                    key={message.id}
                    className={cn(
                      'flex gap-2',
                      isOwn ? 'justify-end' : 'justify-start'
                    )}
                  >
                    {!isOwn && (
                      <Avatar
                        className="h-8 w-8"
                        fallback={contactEmail || '?'}
                      />
                    )}
                    <div
                      className={cn(
                        'max-w-[70%] rounded-lg px-3 py-2',
                        isOwn
                          ? 'bg-primary text-primary-foreground'
                          : 'bg-muted'
                      )}
                    >
                      <p className="text-sm break-words">{message.content}</p>
                      <div
                        className={cn(
                          'flex items-center gap-1 mt-1',
                          isOwn ? 'justify-end' : 'justify-start'
                        )}
                      >
                        <span className="text-xs opacity-70">
                          {formatTime(message.timestamp)}
                        </span>
                        {isOwn && (
                          <span className="text-xs opacity-70">
                            {message.status === 'sending' && '...'}
                            {message.status === 'sent' && '✓'}
                            {message.status === 'delivered' && '✓✓'}
                            {message.status === 'read' && '✓✓'}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ))}
        <div ref={endRef} />
      </div>
    </ScrollArea>
  );
}
```

2. Create frontend/src/components/messaging/MessageInput.tsx:

```typescript
import * as React from 'react';
import { Send } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';

interface MessageInputProps {
  onSend: (message: string) => void;
  disabled?: boolean;
  placeholder?: string;
}

export function MessageInput({ onSend, disabled, placeholder = 'Type a message...' }: MessageInputProps) {
  const [message, setMessage] = React.useState('');
  const textareaRef = React.useRef<HTMLTextAreaElement>(null);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const trimmed = message.trim();
    if (trimmed && !disabled) {
      onSend(trimmed);
      setMessage('');
      // Reset textarea height
      if (textareaRef.current) {
        textareaRef.current.style.height = 'auto';
      }
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  };

  // Auto-resize textarea
  const handleInput = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setMessage(e.target.value);
    const target = e.target;
    target.style.height = 'auto';
    target.style.height = Math.min(target.scrollHeight, 150) + 'px';
  };

  return (
    <form onSubmit={handleSubmit} className="flex items-end gap-2 p-4 border-t">
      <textarea
        ref={textareaRef}
        value={message}
        onChange={handleInput}
        onKeyDown={handleKeyDown}
        placeholder={placeholder}
        disabled={disabled}
        rows={1}
        className={cn(
          'flex-1 resize-none rounded-md border border-input bg-background px-3 py-2',
          'text-sm ring-offset-background placeholder:text-muted-foreground',
          'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring',
          'disabled:cursor-not-allowed disabled:opacity-50',
          'min-h-[40px] max-h-[150px]'
        )}
      />
      <Button
        type="submit"
        size="icon"
        disabled={disabled || !message.trim()}
      >
        <Send className="h-4 w-4" />
        <span className="sr-only">Send message</span>
      </Button>
    </form>
  );
}
```

NOTE: MessageInput supports multi-line with Shift+Enter, auto-resizes, and clears on send.
  </action>
  <verify>npm run build compiles without errors</verify>
  <done>MessageList shows messages with date grouping and status; MessageInput handles composition with auto-resize</done>
</task>

<task type="auto">
  <name>Task 3: Create ConversationList and ConversationView components</name>
  <files>frontend/src/components/messaging/ConversationList.tsx, frontend/src/components/messaging/ConversationView.tsx</files>
  <action>
1. Create frontend/src/components/messaging/ConversationList.tsx:

```typescript
import * as React from 'react';
import { cn } from '@/lib/utils';
import { Avatar } from '@/components/ui/avatar';
import { ScrollArea } from '@/components/ui/scroll-area';

interface Conversation {
  contactId: string;
  contactEmail: string;
  lastMessage?: string;
  lastMessageAt?: Date;
  unreadCount?: number;
}

interface ConversationListProps {
  conversations: Conversation[];
  activeId: string | null;
  onSelect: (contactId: string) => void;
}

function formatRelativeTime(date: Date): string {
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'now';
  if (minutes < 60) return `${minutes}m`;
  if (hours < 24) return `${hours}h`;
  if (days < 7) return `${days}d`;
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

export function ConversationList({ conversations, activeId, onSelect }: ConversationListProps) {
  return (
    <ScrollArea className="h-full">
      <div className="space-y-1 p-2">
        {conversations.length === 0 ? (
          <div className="text-center text-muted-foreground py-8 text-sm">
            No conversations yet
          </div>
        ) : (
          conversations.map((conv) => (
            <button
              key={conv.contactId}
              onClick={() => onSelect(conv.contactId)}
              className={cn(
                'w-full flex items-center gap-3 p-3 rounded-lg text-left',
                'hover:bg-accent transition-colors',
                activeId === conv.contactId && 'bg-accent'
              )}
            >
              <Avatar fallback={conv.contactEmail} className="h-10 w-10" />
              <div className="flex-1 min-w-0">
                <div className="flex items-center justify-between">
                  <span className="font-medium text-sm truncate">
                    {conv.contactEmail}
                  </span>
                  {conv.lastMessageAt && (
                    <span className="text-xs text-muted-foreground">
                      {formatRelativeTime(conv.lastMessageAt)}
                    </span>
                  )}
                </div>
                {conv.lastMessage && (
                  <p className="text-xs text-muted-foreground truncate">
                    {conv.lastMessage}
                  </p>
                )}
              </div>
              {conv.unreadCount && conv.unreadCount > 0 && (
                <span className="bg-primary text-primary-foreground text-xs rounded-full px-2 py-0.5 min-w-[20px] text-center">
                  {conv.unreadCount}
                </span>
              )}
            </button>
          ))
        )}
      </div>
    </ScrollArea>
  );
}
```

2. Create frontend/src/components/messaging/ConversationView.tsx:

```typescript
import * as React from 'react';
import { MessageList } from './MessageList';
import { MessageInput } from './MessageInput';
import { Avatar } from '@/components/ui/avatar';
import { Lock } from 'lucide-react';

interface Message {
  id: number;
  senderId: string;
  content: string;
  timestamp: Date;
  status: 'sending' | 'sent' | 'delivered' | 'read';
}

interface ConversationViewProps {
  contactId: string;
  contactEmail: string;
  currentUserId: string;
  messages: Message[];
  onSendMessage: (content: string) => void;
  isConnected: boolean;
  isLoading?: boolean;
}

export function ConversationView({
  contactId,
  contactEmail,
  currentUserId,
  messages,
  onSendMessage,
  isConnected,
  isLoading,
}: ConversationViewProps) {
  return (
    <div className="flex flex-col h-full">
      {/* Header */}
      <div className="flex items-center gap-3 p-4 border-b">
        <Avatar fallback={contactEmail} className="h-10 w-10" />
        <div className="flex-1">
          <h2 className="font-semibold">{contactEmail}</h2>
          <div className="flex items-center gap-1 text-xs text-muted-foreground">
            <Lock className="h-3 w-3" />
            <span>End-to-end encrypted</span>
          </div>
        </div>
        {!isConnected && (
          <span className="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded">
            Reconnecting...
          </span>
        )}
      </div>

      {/* Messages */}
      {isLoading ? (
        <div className="flex-1 flex items-center justify-center text-muted-foreground">
          Loading messages...
        </div>
      ) : (
        <MessageList
          messages={messages}
          currentUserId={currentUserId}
          contactEmail={contactEmail}
        />
      )}

      {/* Input */}
      <MessageInput
        onSend={onSendMessage}
        disabled={!isConnected}
        placeholder={isConnected ? 'Type a message...' : 'Connecting...'}
      />
    </div>
  );
}
```

3. Create index file for easy imports at frontend/src/components/messaging/index.ts:

```typescript
export { MessageList } from './MessageList';
export { MessageInput } from './MessageInput';
export { ConversationList } from './ConversationList';
export { ConversationView } from './ConversationView';
```
  </action>
  <verify>npm run build compiles without errors</verify>
  <done>ConversationList shows conversation previews; ConversationView combines header, messages, and input with E2E encryption indicator</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Component verification:
   - Avatar.tsx exports Avatar component
   - ScrollArea.tsx exports ScrollArea component
   - MessageList.tsx exports MessageList with date grouping and status indicators
   - MessageInput.tsx exports MessageInput with auto-resize and keyboard handling
   - ConversationList.tsx exports ConversationList with active state
   - ConversationView.tsx exports ConversationView combining all parts

2. Feature verification:
   - Messages display with timestamps and delivery status
   - Message input supports Enter to send, Shift+Enter for newline
   - Conversation list shows last message preview and time
   - E2E encryption indicator in conversation header
   - Connection status indicator

3. Build verification:
   - npm run build succeeds without errors
</verification>

<success_criteria>
- All messaging UI components created and styled
- MessageList groups by date, scrolls to bottom on new messages
- MessageInput clears and auto-resizes appropriately
- ConversationList shows conversation previews with unread counts
- ConversationView shows E2E encryption indicator
- All components use existing Tailwind/shadcn patterns
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-e2e-encrypted-messaging/02-05-SUMMARY.md`
</output>
