---
phase: 02-e2e-encrypted-messaging
plan: 06
type: execute
wave: 4
depends_on: ["02-04", "02-05"]
files_modified:
  - frontend/src/pages/ContactsPage.tsx
  - frontend/src/routes/index.tsx
  - frontend/src/lib/api.ts
  - backend/src/routes/users.ts
  - backend/src/server.ts
autonomous: true

must_haves:
  truths:
    - "User can see list of users to start conversations"
    - "User can search for users by email"
    - "User can navigate to ContactsPage from sidebar"
  artifacts:
    - path: "frontend/src/pages/ContactsPage.tsx"
      provides: "User directory to start new conversations"
      exports: "ContactsPage"
    - path: "backend/src/routes/users.ts"
      provides: "User list endpoint for contact discovery"
      exports: "default (Fastify plugin)"
  key_links:
    - from: "frontend/src/pages/ContactsPage.tsx"
      to: "frontend/src/lib/api.ts"
      via: "import usersApi"
      pattern: "usersApi"
    - from: "frontend/src/pages/ContactsPage.tsx"
      to: "frontend/src/stores/contactStore.ts"
      via: "add contact and navigate to messages"
      pattern: "addContact"
---

<objective>
Create user discovery API and ContactsPage for finding other users to message.

Purpose: Enable users to discover other users and start new conversations
Output: Users API endpoint, ContactsPage with search, routes configured
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-e2e-encrypted-messaging/02-RESEARCH.md
@.planning/phases/02-e2e-encrypted-messaging/02-04-SUMMARY.md
@.planning/phases/02-e2e-encrypted-messaging/02-05-SUMMARY.md

# Existing codebase references
@frontend/src/routes/index.tsx
@frontend/src/lib/api.ts
@frontend/src/stores/contactStore.ts
@backend/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create users API endpoint for contact discovery</name>
  <files>backend/src/routes/users.ts, backend/src/server.ts</files>
  <action>
1. Create backend/src/routes/users.ts:

```typescript
import { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import { query } from '../db/index.js';

interface UserListQuery {
  search?: string;
}

export default async function userRoutes(fastify: FastifyInstance) {
  // Get list of users (for contact discovery)
  fastify.get<{ Querystring: UserListQuery }>(
    '/users',
    { preValidation: [fastify.authenticate] },
    async (request: FastifyRequest<{ Querystring: UserListQuery }>, reply: FastifyReply) => {
      const currentUserId = (request.user as { userId: string }).userId;
      const { search } = request.query;

      let queryText = `
        SELECT id, email, created_at
        FROM users
        WHERE id != $1
      `;
      const params: (string)[] = [currentUserId];

      if (search) {
        queryText += ` AND email ILIKE $2`;
        params.push(`%${search}%`);
      }

      queryText += ` ORDER BY email ASC LIMIT 50`;

      const result = await query(queryText, params);

      return {
        users: result.rows.map((row) => ({
          id: row.id,
          email: row.email,
          createdAt: row.created_at,
        })),
      };
    }
  );

  // Get single user by ID
  fastify.get<{ Params: { userId: string } }>(
    '/users/:userId',
    { preValidation: [fastify.authenticate] },
    async (request: FastifyRequest<{ Params: { userId: string } }>, reply: FastifyReply) => {
      const { userId } = request.params;

      const result = await query(
        'SELECT id, email, created_at FROM users WHERE id = $1',
        [userId]
      );

      if (result.rows.length === 0) {
        return reply.code(404).send({ error: 'User not found' });
      }

      const user = result.rows[0];
      return {
        id: user.id,
        email: user.email,
        createdAt: user.created_at,
      };
    }
  );
}
```

2. Register users routes in backend/src/server.ts:
   ```typescript
   import userRoutes from './routes/users.js';
   // After other route registrations:
   await fastify.register(userRoutes, { prefix: '/api' });
   ```
  </action>
  <verify>npm run build compiles without errors in backend</verify>
  <done>Users API at GET /api/users (with search) and GET /api/users/:userId for contact discovery</done>
</task>

<task type="auto">
  <name>Task 2: Create ContactsPage with user discovery and search</name>
  <files>frontend/src/pages/ContactsPage.tsx, frontend/src/routes/index.tsx, frontend/src/lib/api.ts</files>
  <action>
1. Add users API to frontend/src/lib/api.ts:

```typescript
// Add to existing api.ts

export const usersApi = {
  // Get list of users for contact discovery
  getUsers: async (search?: string): Promise<{ users: { id: string; email: string }[] }> => {
    const params = search ? `?search=${encodeURIComponent(search)}` : '';
    return apiFetch(`/api/users${params}`);
  },

  // Get single user
  getUser: async (userId: string): Promise<{ id: string; email: string }> => {
    return apiFetch(`/api/users/${userId}`);
  },
};
```

2. Create frontend/src/pages/ContactsPage.tsx:

```typescript
import * as React from 'react';
import { useNavigate } from 'react-router';
import { Search, MessageCircle } from 'lucide-react';
import { Avatar } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { usersApi } from '@/lib/api';
import { useContactStore } from '@/stores/contactStore';

interface User {
  id: string;
  email: string;
}

export function ContactsPage() {
  const [users, setUsers] = React.useState<User[]>([]);
  const [search, setSearch] = React.useState('');
  const [isLoading, setIsLoading] = React.useState(true);
  const navigate = useNavigate();
  const { addContact } = useContactStore();

  React.useEffect(() => {
    const fetchUsers = async () => {
      setIsLoading(true);
      try {
        const { users } = await usersApi.getUsers(search || undefined);
        setUsers(users);
      } catch (e) {
        console.error('Failed to fetch users:', e);
      } finally {
        setIsLoading(false);
      }
    };

    const debounce = setTimeout(fetchUsers, 300);
    return () => clearTimeout(debounce);
  }, [search]);

  const startConversation = (user: User) => {
    // Add to contacts store
    addContact({
      id: user.id,
      email: user.email,
      publicKey: null, // Will be fetched when opening conversation
    });
    // Navigate to messages with this contact
    navigate(`/messages/${user.id}`);
  };

  return (
    <div className="p-6 max-w-2xl mx-auto">
      <h1 className="text-2xl font-bold mb-6">Find Users</h1>

      <div className="relative mb-6">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
        <Input
          type="text"
          placeholder="Search by email..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="pl-10"
        />
      </div>

      {isLoading ? (
        <div className="text-center text-muted-foreground py-8">Loading...</div>
      ) : users.length === 0 ? (
        <div className="text-center text-muted-foreground py-8">
          {search ? 'No users found' : 'No other users yet'}
        </div>
      ) : (
        <div className="space-y-2">
          {users.map((user) => (
            <div
              key={user.id}
              className="flex items-center gap-3 p-4 rounded-lg border hover:bg-accent transition-colors"
            >
              <Avatar fallback={user.email} className="h-10 w-10" />
              <div className="flex-1">
                <p className="font-medium">{user.email}</p>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={() => startConversation(user)}
              >
                <MessageCircle className="h-4 w-4 mr-2" />
                Message
              </Button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

3. Update frontend/src/routes/index.tsx to add ContactsPage route:
   - Import ContactsPage from pages
   - Add route: { path: '/contacts', element: <ProtectedRoute><ContactsPage /></ProtectedRoute> }
  </action>
  <verify>npm run build compiles without errors in frontend</verify>
  <done>ContactsPage with user search; route at /contacts configured</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Backend verification:
   - users.ts registered at /api with GET /users and GET /users/:userId
   - All routes require authentication

2. Frontend verification:
   - ContactsPage allows user discovery and starting conversations
   - usersApi in api.ts provides getUsers and getUser methods
   - Route configured for /contacts

3. Build verification:
   - npm run build succeeds for both frontend and backend
</verification>

<success_criteria>
- Users API returns list of users (excluding current user)
- Users API supports search by email
- ContactsPage displays user list with search
- Clicking "Message" adds contact and navigates to messages
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-e2e-encrypted-messaging/02-06-SUMMARY.md`
</output>
