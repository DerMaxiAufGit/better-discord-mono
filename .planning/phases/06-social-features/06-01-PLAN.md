---
phase: 06-social-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema.ts
  - postgres/init.sql
autonomous: true

must_haves:
  truths:
    - "Database has avatars table for storing avatar metadata"
    - "Database has user_presence table for storing status and visibility"
    - "Database has blocks table for user blocking relationships"
    - "Database has user_settings table for privacy preferences"
  artifacts:
    - path: "backend/src/db/schema.ts"
      provides: "TypeScript interfaces for new social tables"
      contains: ["Avatar", "UserPresence", "Block", "UserSettings"]
    - path: "postgres/init.sql"
      provides: "PostgreSQL DDL for social features tables"
      contains: ["CREATE TABLE avatars", "CREATE TABLE user_presence", "CREATE TABLE blocks", "CREATE TABLE user_settings"]
  key_links:
    - from: "backend/src/db/schema.ts"
      to: "postgres/init.sql"
      via: "TypeScript types match PostgreSQL schema"
---

<objective>
Create database schema for Phase 6 social features: avatars, presence, blocking, and user settings.

Purpose: Establish data foundation for all social features before backend services
Output: Updated init.sql with new tables, updated schema.ts with TypeScript interfaces
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-social-features/06-CONTEXT.md
@.planning/phases/06-social-features/06-RESEARCH.md
@backend/src/db/schema.ts
@postgres/init.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add social feature tables to PostgreSQL init.sql</name>
  <files>postgres/init.sql</files>
  <action>
Add the following tables to init.sql after the existing reactions table:

1. **avatars table** - Store avatar metadata (files stored on disk):
```sql
CREATE TABLE IF NOT EXISTS avatars (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    tiny_path VARCHAR(500),      -- 32x32 WebP
    small_path VARCHAR(500),     -- 64x64 WebP
    large_path VARCHAR(500),     -- 256x256 WebP
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id)  -- One avatar per user
);
CREATE INDEX IF NOT EXISTS idx_avatars_user ON avatars(user_id);
```

2. **user_presence table** - Store presence status (Redis for real-time, PostgreSQL for persistence):
```sql
CREATE TABLE IF NOT EXISTS user_presence (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL DEFAULT 'online' CHECK (status IN ('online', 'away', 'dnd', 'invisible')),
    visibility_list UUID[] DEFAULT '{}',  -- User IDs who see true status when invisible
    last_seen TIMESTAMPTZ DEFAULT NOW(),
    show_last_seen BOOLEAN DEFAULT TRUE,  -- Privacy: hide last-seen from others
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

3. **blocks table** - Store user blocking relationships:
```sql
CREATE TABLE IF NOT EXISTS blocks (
    blocker_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    blocked_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (blocker_id, blocked_id)
);
CREATE INDEX IF NOT EXISTS idx_blocks_blocker ON blocks(blocker_id);
CREATE INDEX IF NOT EXISTS idx_blocks_blocked ON blocks(blocked_id);
```

4. **user_settings table** - Store user preferences:
```sql
CREATE TABLE IF NOT EXISTS user_settings (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    show_last_seen BOOLEAN DEFAULT TRUE,
    allow_friend_requests BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

Ensure all tables use proper foreign key constraints and indexes.
  </action>
  <verify>Run `docker compose exec postgres psql -U dev -d chatapp -c "\dt"` to list tables after rebuild</verify>
  <done>Four new tables (avatars, user_presence, blocks, user_settings) exist in PostgreSQL schema</done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript interfaces to schema.ts</name>
  <files>backend/src/db/schema.ts</files>
  <action>
Add TypeScript interfaces matching the new PostgreSQL tables:

```typescript
export type PresenceStatus = 'online' | 'away' | 'dnd' | 'invisible'

export interface Avatar {
  id: string
  user_id: string
  tiny_path: string | null
  small_path: string | null
  large_path: string | null
  created_at: Date
  updated_at: Date
}

export interface UserPresence {
  user_id: string
  status: PresenceStatus
  visibility_list: string[]
  last_seen: Date
  show_last_seen: boolean
  updated_at: Date
}

export interface Block {
  blocker_id: string
  blocked_id: string
  created_at: Date
}

export interface UserSettings {
  user_id: string
  show_last_seen: boolean
  allow_friend_requests: boolean
  created_at: Date
  updated_at: Date
}
```

Place these after the existing Reaction interface.
  </action>
  <verify>Run `npx tsc --noEmit` in backend directory to verify TypeScript compiles</verify>
  <done>TypeScript interfaces Avatar, UserPresence, Block, UserSettings exist and compile without errors</done>
</task>

<task type="auto">
  <name>Task 3: Rebuild database and verify schema</name>
  <files>docker-compose.yml</files>
  <action>
Rebuild the PostgreSQL container to apply schema changes:

```bash
docker compose down
docker compose up -d --build postgres
```

Wait for container to be healthy, then verify tables exist:

```bash
docker compose exec postgres psql -U dev -d chatapp -c "\d avatars"
docker compose exec postgres psql -U dev -d chatapp -c "\d user_presence"
docker compose exec postgres psql -U dev -d chatapp -c "\d blocks"
docker compose exec postgres psql -U dev -d chatapp -c "\d user_settings"
```

Confirm all tables have expected columns and constraints.
  </action>
  <verify>All four tables visible with correct columns when querying PostgreSQL</verify>
  <done>Database rebuilt with new social feature tables verified via psql</done>
</task>

</tasks>

<verification>
1. PostgreSQL has avatars, user_presence, blocks, user_settings tables
2. TypeScript compiles with new interfaces in schema.ts
3. Foreign key constraints reference users(id) correctly
4. Indexes exist for performance-critical columns
</verification>

<success_criteria>
- All four tables created in PostgreSQL with correct schema
- TypeScript interfaces match database schema
- No TypeScript compilation errors
- Database can be dropped and recreated cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-social-features/06-01-SUMMARY.md`
</output>
