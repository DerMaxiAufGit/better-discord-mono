---
phase: 06-social-features
plan: 09
type: execute
wave: 4
depends_on: ["06-05", "06-06", "06-07"]
files_modified:
  - frontend/src/components/presence/StatusPicker.tsx
  - frontend/src/components/presence/VisibilityList.tsx
  - frontend/src/components/presence/LastSeenText.tsx
  - frontend/src/pages/SettingsPage.tsx
  - frontend/src/pages/ContactsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can change status via dropdown picker"
    - "User can manage visibility list for invisible mode"
    - "User sees last-seen timestamps for offline friends"
    - "Avatar with status indicator appears in contacts and conversations"
  artifacts:
    - path: "frontend/src/components/presence/StatusPicker.tsx"
      provides: "Status selection dropdown"
      exports: ["StatusPicker"]
    - path: "frontend/src/components/presence/VisibilityList.tsx"
      provides: "Manage invisible mode visibility"
      exports: ["VisibilityList"]
    - path: "frontend/src/components/presence/LastSeenText.tsx"
      provides: "Formatted last-seen display"
      exports: ["LastSeenText"]
  key_links:
    - from: "frontend/src/components/presence/StatusPicker.tsx"
      to: "frontend/src/stores/presenceStore.ts"
      via: "setMyStatus action"
    - from: "frontend/src/pages/ContactsPage.tsx"
      to: "frontend/src/components/avatar/AvatarDisplay.tsx"
      via: "Avatar with status indicator"
---

<objective>
Create presence UI components and integrate avatars with status indicators throughout the app.

Purpose: Enable users to manage their status and see friends' presence in the UI
Output: Status picker, visibility list manager, last-seen display, integrated avatar+status in contacts
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-social-features/06-CONTEXT.md
@.planning/phases/06-social-features/06-05-SUMMARY.md
@.planning/phases/06-social-features/06-06-SUMMARY.md
@.planning/phases/06-social-features/06-07-SUMMARY.md
@frontend/src/pages/SettingsPage.tsx
@frontend/src/pages/ContactsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create presence UI components</name>
  <files>frontend/src/components/presence/StatusPicker.tsx, frontend/src/components/presence/LastSeenText.tsx, frontend/src/components/presence/VisibilityList.tsx</files>
  <action>
1. Create directory `frontend/src/components/presence/`

2. Create `frontend/src/components/presence/StatusPicker.tsx`:

```typescript
import { useState } from 'react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { usePresenceStore } from '@/stores/presenceStore';
import type { PresenceStatus } from '@/lib/api';
import { Circle, Moon, MinusCircle, Eye, ChevronDown } from 'lucide-react';
import { cn } from '@/lib/utils';

const statusConfig: Record<PresenceStatus, {
  label: string;
  icon: typeof Circle;
  color: string;
  description: string;
}> = {
  online: {
    label: 'Online',
    icon: Circle,
    color: 'text-green-500 fill-green-500',
    description: 'You appear online to everyone',
  },
  away: {
    label: 'Away',
    icon: Moon,
    color: 'text-yellow-500 fill-yellow-500',
    description: 'You appear away',
  },
  dnd: {
    label: 'Do Not Disturb',
    icon: MinusCircle,
    color: 'text-red-500 fill-red-500',
    description: 'No notifications or sounds',
  },
  invisible: {
    label: 'Invisible',
    icon: Eye,
    color: 'text-gray-400',
    description: 'Appear offline to others',
  },
};

interface StatusPickerProps {
  className?: string;
  showLabel?: boolean;
  onStatusChange?: (status: PresenceStatus) => void;
}

export function StatusPicker({
  className,
  showLabel = true,
  onStatusChange,
}: StatusPickerProps) {
  const [isOpen, setIsOpen] = useState(false);
  const { myStatus, setMyStatus } = usePresenceStore();

  const currentConfig = statusConfig[myStatus];
  const Icon = currentConfig.icon;

  const handleSelect = async (status: PresenceStatus) => {
    setIsOpen(false);
    await setMyStatus(status);
    onStatusChange?.(status);
  };

  return (
    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" className={cn('gap-2', className)}>
          <Icon className={cn('h-3 w-3', currentConfig.color)} />
          {showLabel && <span>{currentConfig.label}</span>}
          <ChevronDown className="h-3 w-3 opacity-50" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        {(Object.keys(statusConfig) as PresenceStatus[]).map((status) => {
          const config = statusConfig[status];
          const StatusIcon = config.icon;
          const isSelected = status === myStatus;

          return (
            <DropdownMenuItem
              key={status}
              onClick={() => handleSelect(status)}
              className={cn('flex flex-col items-start gap-1 py-2', isSelected && 'bg-muted')}
            >
              <div className="flex items-center gap-2">
                <StatusIcon className={cn('h-3 w-3', config.color)} />
                <span className="font-medium">{config.label}</span>
              </div>
              <span className="text-xs text-muted-foreground ml-5">
                {config.description}
              </span>
            </DropdownMenuItem>
          );
        })}
        <DropdownMenuSeparator />
        <div className="px-2 py-1.5 text-xs text-muted-foreground">
          Manage visibility in Settings
        </div>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

3. Create `frontend/src/components/presence/LastSeenText.tsx`:

```typescript
import { useEffect, useState } from 'react';
import { cn } from '@/lib/utils';

interface LastSeenTextProps {
  lastSeen: Date | null;
  status: string;
  className?: string;
}

export function LastSeenText({ lastSeen, status, className }: LastSeenTextProps) {
  const [, forceUpdate] = useState({});

  // Update relative time every minute
  useEffect(() => {
    const interval = setInterval(() => forceUpdate({}), 60000);
    return () => clearInterval(interval);
  }, []);

  if (status === 'online') {
    return (
      <span className={cn('text-green-500', className)}>
        Online
      </span>
    );
  }

  if (status === 'away') {
    return (
      <span className={cn('text-yellow-500', className)}>
        Away
      </span>
    );
  }

  if (status === 'dnd') {
    return (
      <span className={cn('text-red-500', className)}>
        Do Not Disturb
      </span>
    );
  }

  // Offline - show last seen
  if (!lastSeen) {
    return (
      <span className={cn('text-muted-foreground', className)}>
        Offline
      </span>
    );
  }

  const relativeTime = getRelativeTime(lastSeen);
  return (
    <span className={cn('text-muted-foreground', className)}>
      Last seen {relativeTime}
    </span>
  );
}

function getRelativeTime(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMinutes = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMinutes < 1) return 'just now';
  if (diffMinutes < 60) return `${diffMinutes}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;

  return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}
```

4. Create `frontend/src/components/presence/VisibilityList.tsx`:

```typescript
import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { ScrollArea } from '@/components/ui/scroll-area';
import { usePresenceStore } from '@/stores/presenceStore';
import { friendsApi } from '@/lib/api';
import { AvatarDisplay } from '@/components/avatar/AvatarDisplay';
import { Loader2, Eye, EyeOff, Save } from 'lucide-react';
import { showSuccess, showError } from '@/lib/toast';

interface Friend {
  id: string;
  username: string;
}

export function VisibilityList() {
  const [friends, setFriends] = useState<Friend[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());

  const { visibilityList, setVisibilityList } = usePresenceStore();

  // Load friends and initialize selection
  useEffect(() => {
    async function loadFriends() {
      try {
        const response = await friendsApi.getFriends();
        const friendsList = response.friends.map((f: any) => ({
          id: f.oderId,
          username: f.username,
        }));
        setFriends(friendsList);
        setSelectedIds(new Set(visibilityList));
      } catch {
        showError('Failed to load friends');
      } finally {
        setIsLoading(false);
      }
    }

    loadFriends();
  }, [visibilityList]);

  const toggleFriend = (friendId: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(friendId)) {
        next.delete(friendId);
      } else {
        next.add(friendId);
      }
      return next;
    });
  };

  const handleSave = async () => {
    setIsSaving(true);
    try {
      await setVisibilityList(Array.from(selectedIds));
      showSuccess('Visibility list updated');
    } catch {
      showError('Failed to update visibility list');
    } finally {
      setIsSaving(false);
    }
  };

  const hasChanges = (() => {
    if (selectedIds.size !== visibilityList.length) return true;
    return !visibilityList.every((id) => selectedIds.has(id));
  })();

  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="space-y-1">
        <h4 className="text-sm font-medium">Invisible Mode Visibility</h4>
        <p className="text-sm text-muted-foreground">
          When you're invisible, selected friends will still see you as online.
          Everyone else will see you as offline.
        </p>
      </div>

      {friends.length === 0 ? (
        <p className="text-sm text-muted-foreground py-4">
          Add friends to manage your visibility list.
        </p>
      ) : (
        <>
          <ScrollArea className="h-[200px] border rounded-md">
            <div className="p-2 space-y-1">
              {friends.map((friend) => (
                <label
                  key={friend.id}
                  className="flex items-center gap-3 p-2 rounded-md hover:bg-muted cursor-pointer"
                >
                  <Checkbox
                    checked={selectedIds.has(friend.id)}
                    onCheckedChange={() => toggleFriend(friend.id)}
                  />
                  <AvatarDisplay userId={friend.id} size="tiny" />
                  <span className="text-sm flex-1">{friend.username}</span>
                  {selectedIds.has(friend.id) ? (
                    <Eye className="h-4 w-4 text-green-500" />
                  ) : (
                    <EyeOff className="h-4 w-4 text-muted-foreground" />
                  )}
                </label>
              ))}
            </div>
          </ScrollArea>

          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">
              {selectedIds.size} of {friends.length} selected
            </span>
            <Button
              size="sm"
              onClick={handleSave}
              disabled={!hasChanges || isSaving}
            >
              {isSaving ? (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <Save className="h-4 w-4 mr-2" />
              )}
              Save
            </Button>
          </div>
        </>
      )}
    </div>
  );
}
```

5. Create `frontend/src/components/presence/index.ts`:

```typescript
export { StatusPicker } from './StatusPicker';
export { LastSeenText } from './LastSeenText';
export { VisibilityList } from './VisibilityList';
```
  </action>
  <verify>Run `npx tsc --noEmit` to verify components compile</verify>
  <done>Presence UI components created: StatusPicker, LastSeenText, VisibilityList</done>
</task>

<task type="auto">
  <name>Task 2: Integrate avatar and presence into SettingsPage</name>
  <files>frontend/src/pages/SettingsPage.tsx</files>
  <action>
Update `frontend/src/pages/SettingsPage.tsx` to add Profile and Presence sections:

Add imports:
```typescript
import { AvatarUpload } from '@/components/avatar/AvatarUpload';
import { StatusPicker } from '@/components/presence/StatusPicker';
import { VisibilityList } from '@/components/presence/VisibilityList';
```

Add Profile section after the existing sections (or create a new section):
```tsx
{/* Profile Section */}
<div className="space-y-6">
  <div>
    <h3 className="text-lg font-medium">Profile</h3>
    <p className="text-sm text-muted-foreground">
      Manage your avatar and profile settings
    </p>
  </div>

  <div className="space-y-4">
    <div>
      <label className="text-sm font-medium">Avatar</label>
      <div className="mt-2">
        <AvatarUpload />
      </div>
    </div>
  </div>
</div>

<Separator />

{/* Presence Section */}
<div className="space-y-6">
  <div>
    <h3 className="text-lg font-medium">Status & Presence</h3>
    <p className="text-sm text-muted-foreground">
      Control how you appear to others
    </p>
  </div>

  <div className="space-y-4">
    <div>
      <label className="text-sm font-medium">Current Status</label>
      <div className="mt-2">
        <StatusPicker />
      </div>
    </div>

    <div>
      <VisibilityList />
    </div>
  </div>
</div>
```

Import Separator if not already imported:
```typescript
import { Separator } from '@/components/ui/separator';
```
  </action>
  <verify>Run `npm run build` to verify page compiles</verify>
  <done>SettingsPage updated with Profile and Presence sections</done>
</task>

<task type="auto">
  <name>Task 3: Integrate avatar with status indicator into ContactsPage</name>
  <files>frontend/src/pages/ContactsPage.tsx</files>
  <action>
Update `frontend/src/pages/ContactsPage.tsx` to show avatars with status indicators:

1. Add imports at top with existing imports:
```typescript
import { AvatarDisplay } from '@/components/avatar/AvatarDisplay';
import { LastSeenText } from '@/components/presence/LastSeenText';
import { usePresenceStore } from '@/stores/presenceStore';
import { useBlockStore } from '@/stores/blockStore';
```

2. In `ContactsPage` component, add store hooks after existing hooks:
```typescript
const { getPresence, fetchBatchPresence } = usePresenceStore();
const { loadBlockedUsers } = useBlockStore();
```

3. Add useEffect after existing useEffects (after the `loadPendingRequests` effect):
```typescript
useEffect(() => {
  loadBlockedUsers();
}, [loadBlockedUsers]);

useEffect(() => {
  if (friends.length > 0) {
    const friendIds = friends.map(f => f.oderId);
    fetchBatchPresence(friendIds);
  }
}, [friends, fetchBatchPresence]);
```

4. In the Friends Tab section, inside the `friends.map()` callback, replace:
```tsx
<Avatar fallback={friend.username} className="h-10 w-10" />
```
with:
```tsx
<AvatarDisplay
  userId={friend.oderId}
  size="small"
  showStatus
  status={getPresence(friend.oderId)?.status as any || 'offline'}
/>
```

5. Update the friend info display from:
```tsx
<div className="flex-1">
  <p className="font-medium">{friend.username}</p>
</div>
```
to:
```tsx
<div className="flex-1">
  <p className="font-medium">{friend.username}</p>
  <LastSeenText
    lastSeen={getPresence(friend.oderId)?.lastSeen || null}
    status={getPresence(friend.oderId)?.status || 'offline'}
    className="text-xs"
  />
</div>
```

Note: ContactsPage uses `friend.oderId` for the userId (from FriendRequest interface).
  </action>
  <verify>Run `npm run build` to verify page compiles</verify>
  <done>ContactsPage shows avatars with status indicators and last-seen text</done>
</task>

</tasks>

<verification>
1. StatusPicker shows current status with colored indicator
2. Status change updates server and broadcasts to friends
3. VisibilityList shows friends with checkboxes
4. LastSeenText shows relative time for offline users
5. ContactsPage shows avatar with status dot overlay
6. Settings page has Profile and Presence sections
</verification>

<success_criteria>
- Status picker dropdown works with all 4 states
- Visibility list save updates server
- Avatar status indicator shows correct color
- Last-seen timestamps update dynamically
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-social-features/06-09-SUMMARY.md`
</output>
