---
phase: 06-social-features
plan: 10
type: execute
wave: 5
depends_on: ["06-08", "06-09"]
files_modified:
  - frontend/src/lib/websocket/useMessaging.ts
  - frontend/src/components/messaging/MessageList.tsx
  - frontend/src/pages/MessagesPage.tsx
autonomous: false

must_haves:
  truths:
    - "Decrypted messages indexed in search cache"
    - "Blocked users' messages show placeholder in groups"
    - "Search accessible from messages page"
    - "All social features integrated and functional"
  artifacts:
    - path: "frontend/src/pages/MessagesPage.tsx"
      provides: "Integrated messages page with search"
  key_links:
    - from: "frontend/src/lib/websocket/useMessaging.ts"
      to: "frontend/src/stores/searchStore.ts"
      via: "Index messages on receive/decrypt"
    - from: "frontend/src/components/messaging/MessageList.tsx"
      to: "frontend/src/stores/blockStore.ts"
      via: "Check blocked status for message display"
---

<objective>
Integrate all Phase 6 features: message search indexing, blocked message placeholders, and final verification.

Purpose: Complete Phase 6 integration and verify all social features work together
Output: Fully integrated social features with verification checkpoint
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-social-features/06-CONTEXT.md
@.planning/phases/06-social-features/06-08-SUMMARY.md
@.planning/phases/06-social-features/06-09-SUMMARY.md
@frontend/src/lib/websocket/useMessaging.ts
@frontend/src/components/messaging/MessageList.tsx
@frontend/src/pages/MessagesPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate message search indexing</name>
  <files>frontend/src/lib/websocket/useMessaging.ts, frontend/src/stores/messageStore.ts</files>
  <action>
1. Update message handling to index decrypted messages for search.

In `frontend/src/lib/websocket/useMessaging.ts` or wherever messages are decrypted:

Add import:
```typescript
import { useSearchStore } from '@/stores/searchStore';
```

After a message is decrypted successfully, index it:
```typescript
// After decrypting a message:
const searchStore = useSearchStore.getState();
searchStore.indexMessage({
  id: message.id,
  conversationId: message.recipientId || message.groupId,  // Use appropriate ID
  conversationType: message.groupId ? 'group' : 'dm',
  senderId: message.senderId,
  senderName: senderName || message.senderId,
  plaintext: decryptedContent,
  timestamp: new Date(message.timestamp || message.createdAt),
});
```

2. In message history loading (when loading past messages):

When batch loading message history and decrypting:
```typescript
// After decrypting multiple messages:
const messagesToIndex = decryptedMessages.map(msg => ({
  id: msg.id,
  conversationId: conversationId,
  conversationType: isGroup ? 'group' : 'dm',
  senderId: msg.senderId,
  senderName: msg.senderName || msg.senderId,
  plaintext: msg.content,
  timestamp: new Date(msg.createdAt),
}));

searchStore.indexMessages(messagesToIndex);
```

3. On message delete, remove from index:
```typescript
// When a message is deleted:
searchStore.deleteFromIndex(messageId);
```

The exact integration points depend on the current code structure.
Key requirement: Every decrypted message gets indexed for search.
  </action>
  <verify>Open app, send messages, verify IndexedDB has entries via DevTools > Application > IndexedDB</verify>
  <done>Decrypted messages automatically indexed for search</done>
</task>

<task type="auto">
  <name>Task 2: Integrate blocked message placeholders in MessageList</name>
  <files>frontend/src/components/messaging/MessageList.tsx</files>
  <action>
Update `frontend/src/components/messaging/MessageList.tsx` to show placeholders for blocked users in group conversations:

Add imports:
```typescript
import { useBlockStore } from '@/stores/blockStore';
import { BlockedMessagePlaceholder } from '@/components/blocking/BlockedMessagePlaceholder';
```

Add store hook in component:
```typescript
const { isBlocked } = useBlockStore();
```

In the message rendering loop, wrap messages from blocked users:

```tsx
{messages.map((message) => {
  const senderBlocked = isBlocked(message.senderId);

  // In group conversations, show placeholder for blocked users
  if (senderBlocked && isGroupConversation) {
    return (
      <BlockedMessagePlaceholder
        key={message.id}
        senderName={message.senderName}
      >
        {/* Original message component */}
        <MessageBubble message={message} />
      </BlockedMessagePlaceholder>
    );
  }

  // Normal message display
  return <MessageBubble key={message.id} message={message} />;
})}
```

Note: In DM conversations, blocked users cannot send messages (server blocks them),
so placeholders are only needed in group conversations.
  </action>
  <verify>Block a user, view group conversation with their messages, verify placeholder appears</verify>
  <done>Blocked users' messages show placeholder with reveal option in groups</done>
</task>

<task type="auto">
  <name>Task 3: Add search to MessagesPage</name>
  <files>frontend/src/pages/MessagesPage.tsx</files>
  <action>
Update `frontend/src/pages/MessagesPage.tsx` to include message search:

Add imports:
```typescript
import { MessageSearchBar, SearchResults } from '@/components/search';
import { useSearchStore } from '@/stores/searchStore';
```

Add state for search panel:
```typescript
const [showSearch, setShowSearch] = useState(false);
const { query, clearSearch } = useSearchStore();
```

Add search toggle button in header (next to other action buttons):
```tsx
<Button
  variant="ghost"
  size="icon"
  onClick={() => setShowSearch(!showSearch)}
  className={showSearch ? 'bg-muted' : ''}
>
  <Search className="h-4 w-4" />
</Button>
```

Add search panel (conditionally rendered):
```tsx
{showSearch && (
  <div className="border-b p-3 space-y-2">
    <MessageSearchBar
      autoFocus
      placeholder="Search all messages..."
    />
    <SearchResults
      onResultClick={(conversationId, messageId) => {
        // Navigate to conversation and scroll to message
        setActiveConversation(conversationId);
        // TODO: scroll to message by ID
        setShowSearch(false);
        clearSearch();
      }}
    />
  </div>
)}
```

Import Search icon:
```typescript
import { Search } from 'lucide-react';
```
  </action>
  <verify>Open MessagesPage, click search icon, type query, verify results appear</verify>
  <done>Search accessible from MessagesPage with results display</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
All Phase 6 Social Features:
1. **Profile Avatars**: Upload, crop, 3 sizes, display with placeholder
2. **Presence System**: Online/Away/DND/Invisible with selective visibility
3. **User Blocking**: Block/unblock, auto-unfriend, message placeholders
4. **Message Search**: Client-side IndexedDB search for encrypted messages
  </what-built>
  <how-to-verify>
1. **Avatar Upload**:
   - Go to Settings > Profile
   - Click "Change Avatar" and select an image
   - Verify cropper modal appears with zoom slider
   - Save and verify avatar appears in contacts list

2. **Presence System**:
   - In Settings, change status to "Away" via dropdown
   - Open second browser with different account
   - Verify first user shows "Away" status
   - Change to "Invisible" - verify shows "Offline" to others
   - Add friend to visibility list - verify they see "Online"

3. **User Blocking**:
   - Click block button on a contact
   - Verify confirmation dialog with history deletion option
   - Block without deleting history
   - Verify cannot send messages (error: "You can't message this user")
   - In group conversation, verify blocked user's messages show placeholder
   - Click "Show" on placeholder to reveal message

4. **Message Search**:
   - Click search icon in messages header
   - Type a search query that matches existing messages
   - Verify results grouped by conversation
   - Click result to navigate to conversation

5. **Integration**:
   - Verify avatars show in contacts with status indicator
   - Verify last-seen timestamps for offline friends
   - Verify auto-away triggers after 5 minutes idle
  </how-to-verify>
  <resume-signal>Type "verified" to complete Phase 6, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Avatars upload, crop, and display correctly
2. Status changes broadcast to friends
3. Invisible mode respects visibility list
4. Blocking prevents messaging and auto-unfriends
5. Group messages from blocked users show placeholder
6. Search finds messages and highlights terms
7. All features work together without conflicts
</verification>

<success_criteria>
- All Phase 6 features functional
- No console errors
- Performance acceptable (search < 500ms)
- UI responsive and intuitive
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/06-social-features/06-10-SUMMARY.md`
</output>
