---
phase: 06-social-features
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/stores/presenceStore.ts
  - frontend/src/pages/ContactsPage.tsx
  - backend/src/services/presenceService.ts
  - backend/src/services/blockService.ts
  - frontend/src/pages/SettingsPage.tsx
  - frontend/src/pages/MessagesPage.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Friends see presence status update live in contacts list without refresh"
    - "Whitelisted friends see invisible user as Online"
    - "After unblock, users can send messages again"
    - "Blocked Users section appears on Contacts page"
    - "Search result click highlights message in group conversations"
  artifacts:
    - path: "frontend/src/stores/presenceStore.ts"
      provides: "Presence state with plain object instead of Map"
      contains: "Record<string, UserPresence>"
    - path: "backend/src/services/presenceService.ts"
      provides: "Correct status loading from database"
      contains: "status: row.status"
    - path: "backend/src/services/blockService.ts"
      provides: "Friendship restoration on unblock"
      contains: "restoreFriendship"
    - path: "frontend/src/pages/ContactsPage.tsx"
      provides: "Blocked Users section"
      contains: "Blocked Users"
    - path: "frontend/src/pages/MessagesPage.tsx"
      provides: "Group message highlighting"
      contains: "highlightMessageId={highlightMessageId}"
  key_links:
    - from: "frontend/src/stores/presenceStore.ts"
      to: "frontend/src/pages/ContactsPage.tsx"
      via: "Zustand selector on plain object"
      pattern: "presenceMap\\[.*\\]"
    - from: "backend/src/services/blockService.ts"
      to: "backend/src/services/friendService.ts"
      via: "restoreFriendship call"
      pattern: "friendService\\.sendRequest"
---

<objective>
Fix 6 diagnosed UAT gaps: presence reactivity, invisible whitelist, unblock messaging, blocked users location, and group search highlighting.

Purpose: Close all remaining UAT issues from Phase 6 testing
Output: All 6 gaps resolved, UAT can pass
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-social-features/06-UAT-v2.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix presence reactivity with plain object</name>
  <files>
    frontend/src/stores/presenceStore.ts
    frontend/src/pages/ContactsPage.tsx
  </files>
  <action>
In presenceStore.ts:
1. Change `presenceMap: Map<string, UserPresence>` to `presenceMap: Record<string, UserPresence>` (plain object)
2. Change initialization from `new Map()` to `{}`
3. Update `updateUserPresence` to use spread operator instead of Map.set:
   ```typescript
   presenceMap: {
     ...state.presenceMap,
     [userId]: { status, lastSeen: lastSeen ? new Date(lastSeen) : null }
   }
   ```
4. Update `fetchUserPresence` similarly with spread operator
5. Update `fetchBatchPresence` to build newMap as plain object and spread
6. Update `getPresence` to use bracket access: `return get().presenceMap[userId]`

In ContactsPage.tsx:
1. Update line 45 selector to destructure specific userId lookups OR keep as-is (plain object reactivity works with Zustand shallow comparison)
2. Update lines 288, 293, 294 from `presenceMap.get(friend.oderId)` to `presenceMap[friend.oderId]`

This fixes gaps 1 & 2 (Tests 4 & 6): Zustand reliably detects changes on plain objects, triggering re-renders for live presence updates.
  </action>
  <verify>
Run `cd frontend && npm run build` - no TypeScript errors
  </verify>
  <done>
presenceMap is a plain Record object, ContactsPage uses bracket access, Zustand reactivity works for presence updates
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix invisible whitelist and unblock friendship restoration</name>
  <files>
    backend/src/services/presenceService.ts
    backend/src/services/blockService.ts
  </files>
  <action>
In presenceService.ts (around line 124):
1. In `getVisibleStatus`, when loading from database for disconnected user, change:
   ```typescript
   status: 'offline' as PresenceStatus,  // Not in cache = offline
   ```
   to:
   ```typescript
   status: row.status as PresenceStatus,  // Preserve actual status for invisible whitelist check
   ```
This fixes gap 3 (Test 7): Invisible users' status is now preserved, allowing whitelist logic to work correctly.

In blockService.ts:
1. Add import for friendService at top (already exists)
2. In `unblockUser` method, after deleting the block record, restore friendship automatically:
   ```typescript
   async unblockUser(blockerId: string, blockedId: string): Promise<void> {
     await query(
       `DELETE FROM blocks WHERE blocker_id = $1 AND blocked_id = $2`,
       [blockerId, blockedId]
     );

     // Auto-restore friendship on unblock (better UX than requiring new friend request)
     try {
       await friendService.sendRequest(blockerId, blockedId);
     } catch {
       // Ignore if already friends or other issues - unblock still succeeded
     }
   }
   ```
This fixes gap 4 (Test 8): Unblock now restores friendship, allowing messaging to resume immediately.
  </action>
  <verify>
Run `cd backend && npm run build` - no TypeScript errors
  </verify>
  <done>
Invisible whitelist preserves actual status from DB, unblock auto-restores friendship
  </done>
</task>

<task type="auto">
  <name>Task 3: Move Blocked Users to Contacts and fix group highlighting</name>
  <files>
    frontend/src/pages/SettingsPage.tsx
    frontend/src/pages/ContactsPage.tsx
    frontend/src/pages/MessagesPage.tsx
  </files>
  <action>
In SettingsPage.tsx:
1. Remove the entire "Blocked Users Section" (lines 167-201)
2. Remove the imports: `Ban` from lucide-react, `useBlockStore` import
3. Remove the state and effects: `unblockingId`, `loadBlockedUsers` useEffect, `handleUnblock` function
4. Remove `showSuccess`, `showError` imports if no longer used

In ContactsPage.tsx:
1. Add state for unblocking: `const [unblockingId, setUnblockingId] = React.useState<string | null>(null);`
2. Add `blockedUsers` from useBlockStore: `const { blockedUsers, loadBlockedUsers, unblockUser } = useBlockStore();`
3. Add `showSuccess`, `showError` imports from '@/lib/toast'
4. Add `Ban`, `X` icons from lucide-react
5. Add handleUnblock function:
   ```typescript
   const handleUnblock = async (userId: string, username: string) => {
     setUnblockingId(userId);
     try {
       await unblockUser(userId);
       showSuccess(`Unblocked ${username}`);
       loadFriends(); // Refresh friends since unblock restores friendship
     } catch (error) {
       showError(error instanceof Error ? error.message : 'Failed to unblock user');
     } finally {
       setUnblockingId(null);
     }
   };
   ```
6. Add Blocked Users section at the bottom of the Friends tab content (after the friends list, before closing PullToRefresh):
   ```tsx
   {/* Blocked Users */}
   {blockedUsers.length > 0 && (
     <div className="mt-8 pt-6 border-t">
       <div className="flex items-center gap-2 mb-4">
         <Ban className="h-5 w-5" />
         <h2 className="text-lg font-semibold">Blocked Users</h2>
       </div>
       <div className="space-y-2">
         {blockedUsers.map((blockedUser) => (
           <div
             key={blockedUser.blockedId}
             className="flex items-center justify-between p-3 rounded-lg border"
           >
             <div className="flex-1">
               <p className="font-medium">{blockedUser.username || 'Unknown User'}</p>
               <p className="text-xs text-muted-foreground">
                 Blocked {new Date(blockedUser.blockedAt).toLocaleDateString()}
               </p>
             </div>
             <Button
               variant="outline"
               size="sm"
               onClick={() => handleUnblock(blockedUser.blockedId, blockedUser.username || 'user')}
               disabled={unblockingId === blockedUser.blockedId}
             >
               <X className="h-4 w-4 mr-2" />
               {unblockingId === blockedUser.blockedId ? 'Unblocking...' : 'Unblock'}
             </Button>
           </div>
         ))}
       </div>
     </div>
   )}
   ```
This fixes gap 5 (Test 10): Blocked Users now on Contacts page.

In MessagesPage.tsx (around line 662-668):
1. Find `renderGroupView` function and the MessageList component inside it
2. Add the missing `highlightMessageId` prop:
   ```tsx
   <MessageList
     messages={formattedMessages}
     currentUserId={user ? String(user.id) : ''}
     contactUsername={group.name}
     onReply={handleGroupReply}
     isGroupConversation={true}
     highlightMessageId={highlightMessageId}
   />
   ```
This fixes gap 6 (Test 12): Group message search results now highlight correctly.
  </action>
  <verify>
Run `cd frontend && npm run build` - no TypeScript errors
  </verify>
  <done>
Blocked Users section moved from Settings to Contacts page, MessageList in groups receives highlightMessageId prop
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd backend && npm run build` passes
2. `cd frontend && npm run build` passes
3. Rebuild containers: `docker compose up -d --build`
4. Manual verification:
   - Gap 1/2: Change presence status -> contacts list updates live without refresh
   - Gap 3: Set invisible, whitelist a friend -> friend sees you as Online
   - Gap 4: Block then unblock a user -> can send messages immediately
   - Gap 5: Blocked Users section visible on Contacts page (not Settings)
   - Gap 6: Search in groups -> click result -> message highlights
</verification>

<success_criteria>
- All 6 UAT gaps addressed
- Frontend and backend build without errors
- presenceMap uses plain object for Zustand reactivity
- Invisible whitelist correctly shows Online to whitelisted friends
- Unblock auto-restores friendship
- Blocked Users on Contacts page
- Group search highlights work
</success_criteria>

<output>
After completion, create `.planning/phases/06-social-features/06-12-SUMMARY.md`
</output>
