---
phase: 05-enhanced-communication
plan: 10
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - frontend/src/components/video/VideoPreview.tsx
  - frontend/src/components/video/VideoControls.tsx
  - frontend/src/components/settings/VideoSettings.tsx
autonomous: true

must_haves:
  truths:
    - "Video preview shows camera feed before joining call"
    - "Video controls toggle camera, blur, and quality"
    - "Video settings allow device selection and quality presets"
  artifacts:
    - path: "frontend/src/components/video/VideoPreview.tsx"
      provides: "Camera preview component"
      exports: ["VideoPreview"]
    - path: "frontend/src/components/video/VideoControls.tsx"
      provides: "Camera control buttons"
      exports: ["VideoControls"]
    - path: "frontend/src/components/settings/VideoSettings.tsx"
      provides: "Video settings panel"
      exports: ["VideoSettings"]
  key_links:
    - from: "VideoPreview.tsx"
      to: "useCamera"
      via: "import"
      pattern: "import.*useCamera"
    - from: "VideoControls.tsx"
      to: "backgroundBlur.ts"
      via: "BackgroundBlurProcessor"
      pattern: "BackgroundBlurProcessor"
---

<objective>
Create video UI components for camera preview, controls, and settings.

Purpose: Enable video call features with camera management
Output: Reusable video components for call UI integration
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-enhanced-communication/05-RESEARCH.md
@.planning/phases/05-enhanced-communication/05-03-SUMMARY.md
@frontend/src/components/call/CallControls.tsx
@frontend/src/components/settings/AudioSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video preview component</name>
  <files>frontend/src/components/video/VideoPreview.tsx</files>
  <action>
Create frontend/src/components/video/ directory and VideoPreview.tsx:

```typescript
import { useEffect, useRef } from 'react'
import { cn } from '@/lib/utils'

interface VideoPreviewProps {
  stream: MediaStream | null
  isActive: boolean
  isMirrored?: boolean
  showPlaceholder?: boolean
  className?: string
  onClick?: () => void
}

export function VideoPreview({
  stream,
  isActive,
  isMirrored = true,
  showPlaceholder = true,
  className,
  onClick
}: VideoPreviewProps) {
  const videoRef = useRef<HTMLVideoElement>(null)

  useEffect(() => {
    if (videoRef.current) {
      if (stream && isActive) {
        videoRef.current.srcObject = stream
      } else {
        videoRef.current.srcObject = null
      }
    }
  }, [stream, isActive])

  return (
    <div
      className={cn(
        'relative bg-gray-900 rounded-lg overflow-hidden',
        onClick && 'cursor-pointer hover:ring-2 hover:ring-blue-500',
        className
      )}
      onClick={onClick}
    >
      {isActive && stream ? (
        <video
          ref={videoRef}
          autoPlay
          playsInline
          muted
          className={cn(
            'w-full h-full object-cover',
            isMirrored && 'scale-x-[-1]'
          )}
        />
      ) : showPlaceholder ? (
        <div className="w-full h-full flex items-center justify-center">
          <div className="text-gray-500 text-center">
            <svg
              className="w-16 h-16 mx-auto mb-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={1.5}
                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
              />
            </svg>
            <p className="text-sm">Camera off</p>
          </div>
        </div>
      ) : null}
    </div>
  )
}

interface SelfViewProps {
  stream: MediaStream | null
  isActive: boolean
  position?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right'
  size?: 'small' | 'medium' | 'large'
  onHide?: () => void
}

export function SelfView({
  stream,
  isActive,
  position = 'bottom-right',
  size = 'small',
  onHide
}: SelfViewProps) {
  const positionClasses = {
    'top-left': 'top-4 left-4',
    'top-right': 'top-4 right-4',
    'bottom-left': 'bottom-4 left-4',
    'bottom-right': 'bottom-4 right-4'
  }

  const sizeClasses = {
    small: 'w-32 h-24',
    medium: 'w-48 h-36',
    large: 'w-64 h-48'
  }

  if (!isActive) return null

  return (
    <div className={cn('absolute z-10', positionClasses[position])}>
      <VideoPreview
        stream={stream}
        isActive={isActive}
        className={cn(sizeClasses[size], 'shadow-lg border border-gray-700')}
        showPlaceholder={false}
      />
      {onHide && (
        <button
          onClick={onHide}
          className="absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      )}
    </div>
  )
}
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>VideoPreview.tsx exports VideoPreview and SelfView components</done>
</task>

<task type="auto">
  <name>Task 2: Create video controls component</name>
  <files>frontend/src/components/video/VideoControls.tsx</files>
  <action>
Create VideoControls.tsx:

```typescript
import { useState, useCallback } from 'react'
import { cn } from '@/lib/utils'
import { isBlurSupported } from '@/lib/video/backgroundBlur'
import type { VideoQuality } from '@/lib/video/videoConstraints'

interface VideoControlsProps {
  isCameraOn: boolean
  isBlurOn: boolean
  quality: VideoQuality
  onToggleCamera: () => void
  onToggleBlur: () => void
  onQualityChange: (quality: VideoQuality) => void
  disabled?: boolean
  compact?: boolean
}

export function VideoControls({
  isCameraOn,
  isBlurOn,
  quality,
  onToggleCamera,
  onToggleBlur,
  onQualityChange,
  disabled = false,
  compact = false
}: VideoControlsProps) {
  const [showQualityMenu, setShowQualityMenu] = useState(false)
  const blurSupported = isBlurSupported()

  return (
    <div className={cn('flex items-center gap-2', compact ? 'gap-1' : 'gap-3')}>
      {/* Camera toggle */}
      <button
        onClick={onToggleCamera}
        disabled={disabled}
        className={cn(
          'p-3 rounded-full transition-colors',
          isCameraOn
            ? 'bg-gray-700 text-white hover:bg-gray-600'
            : 'bg-red-600 text-white hover:bg-red-500',
          disabled && 'opacity-50 cursor-not-allowed',
          compact && 'p-2'
        )}
        title={isCameraOn ? 'Turn off camera' : 'Turn on camera'}
      >
        {isCameraOn ? (
          <svg className={cn('w-6 h-6', compact && 'w-5 h-5')} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        ) : (
          <svg className={cn('w-6 h-6', compact && 'w-5 h-5')} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
          </svg>
        )}
      </button>

      {/* Blur toggle (only show if supported) */}
      {blurSupported && (
        <button
          onClick={onToggleBlur}
          disabled={disabled || !isCameraOn}
          className={cn(
            'p-3 rounded-full transition-colors',
            isBlurOn
              ? 'bg-blue-600 text-white hover:bg-blue-500'
              : 'bg-gray-700 text-white hover:bg-gray-600',
            (disabled || !isCameraOn) && 'opacity-50 cursor-not-allowed',
            compact && 'p-2'
          )}
          title={isBlurOn ? 'Disable blur' : 'Enable blur'}
        >
          <svg className={cn('w-6 h-6', compact && 'w-5 h-5')} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </button>
      )}

      {/* Quality selector */}
      {!compact && (
        <div className="relative">
          <button
            onClick={() => setShowQualityMenu(!showQualityMenu)}
            disabled={disabled}
            className={cn(
              'px-3 py-2 rounded-lg bg-gray-700 text-white text-sm hover:bg-gray-600 transition-colors',
              disabled && 'opacity-50 cursor-not-allowed'
            )}
          >
            {quality.charAt(0).toUpperCase() + quality.slice(1)}
          </button>

          {showQualityMenu && (
            <div className="absolute bottom-full left-0 mb-2 bg-gray-800 rounded-lg shadow-lg py-1 min-w-[100px]">
              {(['low', 'medium', 'high'] as VideoQuality[]).map((q) => (
                <button
                  key={q}
                  onClick={() => {
                    onQualityChange(q)
                    setShowQualityMenu(false)
                  }}
                  className={cn(
                    'w-full px-4 py-2 text-left text-sm hover:bg-gray-700',
                    quality === q ? 'text-blue-400' : 'text-white'
                  )}
                >
                  {q.charAt(0).toUpperCase() + q.slice(1)}
                </button>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  )
}

export function VideoControlBar({
  isCameraOn,
  isBlurOn,
  onToggleCamera,
  onToggleBlur,
  disabled = false
}: Omit<VideoControlsProps, 'quality' | 'onQualityChange' | 'compact'>) {
  const blurSupported = isBlurSupported()

  return (
    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-black/50 rounded-full px-4 py-2">
      <button
        onClick={onToggleCamera}
        disabled={disabled}
        className={cn(
          'p-2 rounded-full transition-colors',
          isCameraOn ? 'text-white hover:bg-white/20' : 'text-red-500 hover:bg-red-500/20'
        )}
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      </button>

      {blurSupported && isCameraOn && (
        <button
          onClick={onToggleBlur}
          disabled={disabled}
          className={cn(
            'p-2 rounded-full transition-colors',
            isBlurOn ? 'text-blue-400 hover:bg-blue-500/20' : 'text-white hover:bg-white/20'
          )}
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </button>
      )}
    </div>
  )
}
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>VideoControls.tsx exports VideoControls and VideoControlBar</done>
</task>

<task type="auto">
  <name>Task 3: Create video settings component</name>
  <files>frontend/src/components/settings/VideoSettings.tsx</files>
  <action>
Create VideoSettings.tsx:

```typescript
import { useState, useEffect } from 'react'
import { useCamera } from '@/hooks/useCamera'
import { VideoPreview } from '@/components/video/VideoPreview'
import { VideoControls } from '@/components/video/VideoControls'
import { isBlurSupported } from '@/lib/video/backgroundBlur'
import type { VideoQuality } from '@/lib/video/videoConstraints'

interface VideoSettingsProps {
  onClose?: () => void
}

export function VideoSettings({ onClose }: VideoSettingsProps) {
  const {
    stream,
    isActive,
    error,
    devices,
    selectedDeviceId,
    start,
    stop,
    switchDevice,
    setQuality
  } = useCamera({ autoStart: true, quality: 'medium' })

  const [quality, setQualityState] = useState<VideoQuality>('medium')
  const [isBlurOn, setIsBlurOn] = useState(false)
  const blurSupported = isBlurSupported()

  // Handle quality change
  const handleQualityChange = async (newQuality: VideoQuality) => {
    setQualityState(newQuality)
    await setQuality(newQuality)
    // Save to localStorage
    localStorage.setItem('video-quality', newQuality)
  }

  // Handle device change
  const handleDeviceChange = async (e: React.ChangeEvent<HTMLSelectElement>) => {
    const deviceId = e.target.value
    await switchDevice(deviceId)
    // Save to localStorage
    localStorage.setItem('video-device', deviceId)
  }

  // Load saved settings
  useEffect(() => {
    const savedQuality = localStorage.getItem('video-quality') as VideoQuality | null
    const savedDevice = localStorage.getItem('video-device')
    const savedBlur = localStorage.getItem('video-blur')

    if (savedQuality) {
      setQualityState(savedQuality)
      setQuality(savedQuality)
    }

    if (savedDevice && devices.some(d => d.deviceId === savedDevice)) {
      switchDevice(savedDevice)
    }

    if (savedBlur === 'true') {
      setIsBlurOn(true)
    }
  }, [devices])

  // Save blur preference
  const handleBlurToggle = () => {
    const newValue = !isBlurOn
    setIsBlurOn(newValue)
    localStorage.setItem('video-blur', String(newValue))
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-medium">Video Settings</h3>
        {onClose && (
          <button onClick={onClose} className="text-gray-400 hover:text-white">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        )}
      </div>

      {/* Preview */}
      <div className="aspect-video max-w-md mx-auto">
        <VideoPreview
          stream={stream}
          isActive={isActive}
          className="w-full h-full"
        />
      </div>

      {/* Error */}
      {error && (
        <p className="text-red-500 text-sm">{error}</p>
      )}

      {/* Controls */}
      <div className="flex justify-center">
        <VideoControls
          isCameraOn={isActive}
          isBlurOn={isBlurOn}
          quality={quality}
          onToggleCamera={isActive ? stop : start}
          onToggleBlur={handleBlurToggle}
          onQualityChange={handleQualityChange}
        />
      </div>

      {/* Camera Selection */}
      <div className="space-y-2">
        <label className="block text-sm font-medium text-gray-300">Camera</label>
        <select
          value={selectedDeviceId || ''}
          onChange={handleDeviceChange}
          className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white"
        >
          {devices.length === 0 ? (
            <option value="">No cameras found</option>
          ) : (
            devices.map((device) => (
              <option key={device.deviceId} value={device.deviceId}>
                {device.label || `Camera ${device.deviceId.slice(0, 8)}`}
              </option>
            ))
          )}
        </select>
      </div>

      {/* Quality Selection */}
      <div className="space-y-2">
        <label className="block text-sm font-medium text-gray-300">Video Quality</label>
        <select
          value={quality}
          onChange={(e) => handleQualityChange(e.target.value as VideoQuality)}
          className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white"
        >
          <option value="low">Low (360p, 15fps)</option>
          <option value="medium">Medium (720p, 24fps)</option>
          <option value="high">High (1080p, 30fps)</option>
        </select>
        <p className="text-xs text-gray-500">
          Lower quality uses less bandwidth and works better on slower connections.
        </p>
      </div>

      {/* Blur Toggle */}
      {blurSupported && (
        <div className="flex items-center justify-between">
          <div>
            <label className="block text-sm font-medium text-gray-300">Background Blur</label>
            <p className="text-xs text-gray-500">Blur your background during video calls</p>
          </div>
          <button
            onClick={handleBlurToggle}
            className={`relative w-11 h-6 rounded-full transition-colors ${
              isBlurOn ? 'bg-blue-600' : 'bg-gray-600'
            }`}
          >
            <span
              className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${
                isBlurOn ? 'translate-x-5' : ''
              }`}
            />
          </button>
        </div>
      )}

      {!blurSupported && (
        <p className="text-sm text-yellow-600">
          Background blur is only available in Chrome, Edge, and Opera browsers.
        </p>
      )}
    </div>
  )
}
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>VideoSettings.tsx exports VideoSettings with camera preview and controls</done>
</task>

</tasks>

<verification>
1. Frontend TypeScript compiles
2. VideoPreview shows camera feed with mirror option
3. VideoControls toggle camera, blur, quality
4. VideoSettings saves preferences to localStorage
</verification>

<success_criteria>
- Camera preview displays video stream
- Controls toggle camera on/off
- Blur button disabled when camera off
- Quality selector shows Low/Medium/High
- Settings persist across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-communication/05-10-SUMMARY.md`
</output>
