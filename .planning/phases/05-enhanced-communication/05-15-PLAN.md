---
phase: 05-enhanced-communication
plan: 15
type: execute
wave: 5
depends_on: ["05-10"]
files_modified:
  - frontend/src/components/call/ActiveCallWindow.tsx
  - frontend/src/stores/settingsStore.ts
  - frontend/src/hooks/useCall.ts
autonomous: true

must_haves:
  truths:
    - "Video toggle button added to call controls"
    - "Camera stream integrated with existing call flow"
    - "Video settings persisted in settings store"
  artifacts:
    - path: "frontend/src/components/call/ActiveCallWindow.tsx"
      provides: "Updated call window with video"
      contains: "VideoPreview"
    - path: "frontend/src/stores/settingsStore.ts"
      provides: "Video settings persistence"
      contains: "videoQuality"
    - path: "frontend/src/hooks/useCall.ts"
      provides: "Video track management"
      contains: "toggleVideo"
  key_links:
    - from: "ActiveCallWindow.tsx"
      to: "VideoPreview"
      via: "import"
      pattern: "import.*VideoPreview"
    - from: "useCall.ts"
      to: "useCamera"
      via: "import"
      pattern: "import.*useCamera"
---

<objective>
Integrate video into existing call flow with camera controls and settings.

Purpose: Enable video calls by adding video track management to existing WebRTC
Output: Working video calls with camera toggle and quality settings
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-enhanced-communication/05-RESEARCH.md
@.planning/phases/05-enhanced-communication/05-10-SUMMARY.md
@frontend/src/components/call/ActiveCallWindow.tsx
@frontend/src/hooks/useCall.ts
@frontend/src/stores/settingsStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add video settings to settings store</name>
  <files>frontend/src/stores/settingsStore.ts</files>
  <action>
Update settingsStore.ts to include video settings:

```typescript
// Add to existing settingsStore interface:
interface SettingsState {
  // ... existing audio settings ...

  // Video settings
  videoQuality: 'low' | 'medium' | 'high'
  preferredCameraId: string | null
  blurEnabled: boolean
  selfViewPosition: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right'
  selfViewHidden: boolean

  // Video actions
  setVideoQuality: (quality: 'low' | 'medium' | 'high') => void
  setPreferredCameraId: (deviceId: string | null) => void
  setBlurEnabled: (enabled: boolean) => void
  setSelfViewPosition: (position: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right') => void
  setSelfViewHidden: (hidden: boolean) => void
}

// Add to initial state:
videoQuality: (localStorage.getItem('video-quality') as 'low' | 'medium' | 'high') || 'medium',
preferredCameraId: localStorage.getItem('video-device'),
blurEnabled: localStorage.getItem('video-blur') === 'true',
selfViewPosition: 'bottom-right',
selfViewHidden: false,

// Add actions:
setVideoQuality: (quality) => {
  localStorage.setItem('video-quality', quality)
  set({ videoQuality: quality })
},

setPreferredCameraId: (deviceId) => {
  if (deviceId) {
    localStorage.setItem('video-device', deviceId)
  } else {
    localStorage.removeItem('video-device')
  }
  set({ preferredCameraId: deviceId })
},

setBlurEnabled: (enabled) => {
  localStorage.setItem('video-blur', String(enabled))
  set({ blurEnabled: enabled })
},

setSelfViewPosition: (position) => set({ selfViewPosition: position }),
setSelfViewHidden: (hidden) => set({ selfViewHidden: hidden }),
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>settingsStore includes video settings with persistence</done>
</task>

<task type="auto">
  <name>Task 2: Add video track management to useCall</name>
  <files>frontend/src/hooks/useCall.ts</files>
  <action>
Update useCall.ts to support video tracks:

```typescript
// Add imports:
import { useCamera } from '@/hooks/useCamera'
import { useSettingsStore } from '@/stores/settingsStore'

// Add to hook state:
const [isVideoEnabled, setIsVideoEnabled] = useState(false)
const [localVideoStream, setLocalVideoStream] = useState<MediaStream | null>(null)
const [remoteVideoStream, setRemoteVideoStream] = useState<MediaStream | null>(null)

const videoQuality = useSettingsStore((s) => s.videoQuality)
const preferredCameraId = useSettingsStore((s) => s.preferredCameraId)

const camera = useCamera({
  quality: videoQuality,
  deviceId: preferredCameraId || undefined
})

// Add toggle function:
const toggleVideo = useCallback(async () => {
  if (isVideoEnabled) {
    // Stop video
    camera.stop()
    setIsVideoEnabled(false)
    setLocalVideoStream(null)

    // Remove video track from peer connection
    const senders = peerConnection.current?.getSenders()
    const videoSender = senders?.find(s => s.track?.kind === 'video')
    if (videoSender) {
      peerConnection.current?.removeTrack(videoSender)
    }
  } else {
    // Start video
    await camera.start()
    if (camera.stream) {
      setLocalVideoStream(camera.stream)
      setIsVideoEnabled(true)

      // Add video track to peer connection
      const videoTrack = camera.stream.getVideoTracks()[0]
      if (videoTrack && peerConnection.current) {
        peerConnection.current.addTrack(videoTrack, camera.stream)
      }
    }
  }
}, [isVideoEnabled, camera])

// Handle incoming video tracks:
// In the existing ontrack handler, also handle video:
if (track.kind === 'video') {
  setRemoteVideoStream(new MediaStream([track]))
}

// Add to return object:
return {
  // ... existing returns ...
  isVideoEnabled,
  localVideoStream,
  remoteVideoStream,
  toggleVideo
}
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>useCall supports video track toggle and streams</done>
</task>

<task type="auto">
  <name>Task 3: Update ActiveCallWindow with video</name>
  <files>frontend/src/components/call/ActiveCallWindow.tsx</files>
  <action>
Update ActiveCallWindow.tsx to display video:

```typescript
// Add imports:
import { VideoPreview, SelfView } from '@/components/video/VideoPreview'
import { VideoControlBar } from '@/components/video/VideoControls'
import { useSettingsStore } from '@/stores/settingsStore'

// In the component, get video state from useCall:
const {
  // ... existing destructuring ...
  isVideoEnabled,
  localVideoStream,
  remoteVideoStream,
  toggleVideo
} = useCall()

const { selfViewPosition, selfViewHidden, blurEnabled, setBlurEnabled } = useSettingsStore()

// Update the call window content:
<div className="relative flex-1 flex items-center justify-center bg-gray-900">
  {/* Remote video or avatar */}
  {remoteVideoStream && !remoteVideoStream.getVideoTracks()[0]?.muted ? (
    <VideoPreview
      stream={remoteVideoStream}
      isActive={true}
      isMirrored={false}
      className="w-full h-full"
      onClick={() => {/* Fullscreen toggle */}}
    />
  ) : (
    <div className="flex flex-col items-center gap-4">
      <Avatar className="w-24 h-24">
        <AvatarFallback className="text-3xl">
          {contact?.email.charAt(0).toUpperCase()}
        </AvatarFallback>
      </Avatar>
      <p className="text-lg">{contact?.email.split('@')[0]}</p>
    </div>
  )}

  {/* Self view */}
  {!selfViewHidden && localVideoStream && (
    <SelfView
      stream={localVideoStream}
      isActive={isVideoEnabled}
      position={selfViewPosition}
      size="small"
      onHide={() => useSettingsStore.getState().setSelfViewHidden(true)}
    />
  )}

  {/* Video controls overlay */}
  <VideoControlBar
    isCameraOn={isVideoEnabled}
    isBlurOn={blurEnabled}
    onToggleCamera={toggleVideo}
    onToggleBlur={() => setBlurEnabled(!blurEnabled)}
  />
</div>

// Update the controls section to include video toggle:
<CallControls
  // ... existing props ...
  isVideoEnabled={isVideoEnabled}
  onToggleVideo={toggleVideo}
/>
```

Also update CallControls.tsx to accept video toggle props and show video button.
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>ActiveCallWindow displays local and remote video with controls</done>
</task>

</tasks>

<verification>
1. Frontend TypeScript compiles
2. Video settings persist to localStorage
3. useCall returns video toggle and streams
4. ActiveCallWindow shows video preview when enabled
5. Self-view overlay positioned correctly
</verification>

<success_criteria>
- Video toggle button in call controls
- Camera starts when video enabled
- Remote video displays when peer has camera
- Self-view can be hidden
- Video quality setting respected
- Settings persist across sessions
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-communication/05-15-SUMMARY.md`
</output>
