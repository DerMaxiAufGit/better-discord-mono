---
phase: 05-enhanced-communication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - postgres/init.sql
  - backend/src/db/schema.ts
autonomous: true

must_haves:
  truths:
    - "Groups table exists with name, description, avatar_url, owner_id"
    - "Group_members table tracks user roles (owner, admin, moderator, member)"
    - "Files table stores metadata with conversation_id, encrypted_key references"
    - "Reactions table stores encrypted reaction data per message per user"
    - "Group invites table supports shareable invite links with expiry"
  artifacts:
    - path: "postgres/init.sql"
      provides: "Database schema for groups, files, reactions"
      contains: "CREATE TABLE groups"
    - path: "backend/src/db/schema.ts"
      provides: "TypeScript types for new tables"
      exports: ["Group", "GroupMember", "File", "Reaction", "GroupInvite"]
  key_links:
    - from: "group_members"
      to: "groups"
      via: "group_id foreign key"
      pattern: "REFERENCES groups"
    - from: "reactions"
      to: "messages"
      via: "message_id foreign key"
      pattern: "REFERENCES messages"
---

<objective>
Create database schema for Phase 5 features: groups, files, and reactions.

Purpose: Foundation tables required by all Wave 2+ backend services
Output: SQL schema additions and TypeScript type definitions
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enhanced-communication/05-RESEARCH.md
@postgres/init.sql
@backend/src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add groups and group_members tables</name>
  <files>postgres/init.sql</files>
  <action>
Add groups table with:
- id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
- name: VARCHAR(100) NOT NULL
- description: TEXT
- avatar_url: TEXT
- owner_id: UUID NOT NULL REFERENCES users(id)
- created_at: TIMESTAMPTZ DEFAULT NOW()
- updated_at: TIMESTAMPTZ DEFAULT NOW()

Add group_members table with:
- id: SERIAL PRIMARY KEY
- group_id: UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE
- user_id: UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE
- role: VARCHAR(20) NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'moderator', 'member'))
- joined_at: TIMESTAMPTZ DEFAULT NOW()
- UNIQUE(group_id, user_id)

Add group_invites table with:
- id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
- group_id: UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE
- code: VARCHAR(20) NOT NULL UNIQUE
- created_by: UUID NOT NULL REFERENCES users(id)
- expires_at: TIMESTAMPTZ
- max_uses: INTEGER
- uses: INTEGER DEFAULT 0
- created_at: TIMESTAMPTZ DEFAULT NOW()

Add group_bans table with:
- id: SERIAL PRIMARY KEY
- group_id: UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE
- user_id: UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE
- banned_by: UUID NOT NULL REFERENCES users(id)
- reason: TEXT
- banned_at: TIMESTAMPTZ DEFAULT NOW()
- UNIQUE(group_id, user_id)

Create indexes: idx_group_members_group_id, idx_group_members_user_id, idx_group_invites_code
  </action>
  <verify>Run: docker exec -i $(docker ps -qf "name=postgres") psql -U dev -d chatapp -c "\dt" | Check tables exist</verify>
  <done>Groups, group_members, group_invites, group_bans tables exist with correct schema</done>
</task>

<task type="auto">
  <name>Task 2: Add files and reactions tables</name>
  <files>postgres/init.sql</files>
  <action>
Add files table with:
- id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
- conversation_id: UUID (nullable - can be group_id or null for DM context)
- message_id: INTEGER REFERENCES messages(id) ON DELETE SET NULL
- uploader_id: UUID NOT NULL REFERENCES users(id)
- filename: VARCHAR(255) NOT NULL (original filename, encrypted on client)
- mime_type: VARCHAR(127) NOT NULL
- size_bytes: BIGINT NOT NULL
- storage_path: TEXT NOT NULL (server disk path)
- encryption_header: BYTEA NOT NULL (libsodium SecretStream header)
- created_at: TIMESTAMPTZ DEFAULT NOW()

Add reactions table with:
- id: SERIAL PRIMARY KEY
- message_id: INTEGER NOT NULL REFERENCES messages(id) ON DELETE CASCADE
- user_id: UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE
- emoji: VARCHAR(32) NOT NULL (encrypted emoji data)
- created_at: TIMESTAMPTZ DEFAULT NOW()
- UNIQUE(message_id, user_id, emoji) -- one reaction per emoji per user

Create indexes: idx_files_message_id, idx_files_uploader_id, idx_reactions_message_id

Update messages table to support groups:
- Add column: group_id UUID REFERENCES groups(id) ON DELETE CASCADE
- Add column: reply_to_id INTEGER REFERENCES messages(id) ON DELETE SET NULL
- Make recipient_id nullable (NULL for group messages)
  </action>
  <verify>Run: docker exec -i $(docker ps -qf "name=postgres") psql -U dev -d chatapp -c "\d files" && "\d reactions"</verify>
  <done>Files and reactions tables exist, messages table has group_id and reply_to_id columns</done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript type definitions</name>
  <files>backend/src/db/schema.ts</files>
  <action>
Export TypeScript interfaces matching the new tables:

```typescript
export interface Group {
  id: string
  name: string
  description: string | null
  avatar_url: string | null
  owner_id: string
  created_at: Date
  updated_at: Date
}

export type GroupRole = 'owner' | 'admin' | 'moderator' | 'member'

export interface GroupMember {
  id: number
  group_id: string
  user_id: string
  role: GroupRole
  joined_at: Date
}

export interface GroupInvite {
  id: string
  group_id: string
  code: string
  created_by: string
  expires_at: Date | null
  max_uses: number | null
  uses: number
  created_at: Date
}

export interface GroupBan {
  id: number
  group_id: string
  user_id: string
  banned_by: string
  reason: string | null
  banned_at: Date
}

export interface FileRecord {
  id: string
  conversation_id: string | null
  message_id: number | null
  uploader_id: string
  filename: string
  mime_type: string
  size_bytes: number
  storage_path: string
  encryption_header: Buffer
  created_at: Date
}

export interface Reaction {
  id: number
  message_id: number
  user_id: string
  emoji: string
  created_at: Date
}
```

Also update existing Message interface to include:
- group_id: string | null
- reply_to_id: number | null
  </action>
  <verify>Run: cd backend && npx tsc --noEmit</verify>
  <done>TypeScript compiles without errors, all new types exported</done>
</task>

</tasks>

<verification>
1. Docker PostgreSQL shows all new tables: groups, group_members, group_invites, group_bans, files, reactions
2. Messages table has group_id and reply_to_id columns
3. TypeScript backend compiles without errors
4. Foreign key relationships enforced (test with invalid insert)
</verification>

<success_criteria>
- All Phase 5 database tables created with correct schema
- Indexes created for frequently queried columns
- TypeScript types match database schema exactly
- Backend compiles without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-communication/05-01-SUMMARY.md`
</output>
