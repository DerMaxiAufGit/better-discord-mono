---
phase: 05-enhanced-communication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - backend/src/routes/websocket.ts
  - backend/src/services/typingService.ts
autonomous: true

must_haves:
  truths:
    - "Frontend has emoji-picker-react, yet-another-react-lightbox, @mediapipe/selfie_segmentation installed"
    - "WebSocket handles typing events and broadcasts to conversation participants"
    - "Server-side typing timeout clears stale indicators after 10 seconds"
  artifacts:
    - path: "frontend/package.json"
      provides: "New frontend dependencies"
      contains: "emoji-picker-react"
    - path: "backend/src/services/typingService.ts"
      provides: "Typing indicator state management"
      exports: ["handleTypingEvent", "getTypingUsers", "clearStaleTyping"]
    - path: "backend/src/routes/websocket.ts"
      provides: "Typing WebSocket message handling"
      contains: "typing"
  key_links:
    - from: "websocket.ts"
      to: "typingService.ts"
      via: "handleTypingEvent import"
      pattern: "import.*typingService"
---

<objective>
Install Phase 5 frontend dependencies and implement typing indicator backend infrastructure.

Purpose: Enable emoji picker, lightbox, and typing indicators for messaging features
Output: Updated dependencies and working typing indicator WebSocket events
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-enhanced-communication/05-RESEARCH.md
@frontend/package.json
@backend/src/routes/websocket.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install frontend dependencies</name>
  <files>frontend/package.json</files>
  <action>
Run npm install in frontend directory:
```bash
cd frontend && npm install emoji-picker-react@^5 yet-another-react-lightbox@^3 @mediapipe/selfie_segmentation react-window @types/react-window
```

These provide:
- emoji-picker-react: Virtualized emoji picker with Twemoji support
- yet-another-react-lightbox: Image gallery with zoom/pan
- @mediapipe/selfie_segmentation: Background blur for video
- react-window: Virtualized list rendering (emoji picker uses internally)

Verify package.json has new dependencies.
  </action>
  <verify>Run: cd frontend && npm ls emoji-picker-react yet-another-react-lightbox @mediapipe/selfie_segmentation</verify>
  <done>All dependencies installed and listed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create typing indicator service</name>
  <files>backend/src/services/typingService.ts</files>
  <action>
Create typingService.ts with:

```typescript
// Map: "conversationId:userId" -> timestamp
const typingStates = new Map<string, number>()

export function handleTypingEvent(
  conversationId: string,
  userId: string,
  isTyping: boolean
): void {
  const key = `${conversationId}:${userId}`

  if (isTyping) {
    typingStates.set(key, Date.now())
  } else {
    typingStates.delete(key)
  }
}

export function getTypingUsers(conversationId: string): string[] {
  const users: string[] = []
  const now = Date.now()

  for (const [key, timestamp] of typingStates.entries()) {
    if (key.startsWith(`${conversationId}:`)) {
      // Only include if within timeout (10s)
      if (now - timestamp < 10000) {
        const userId = key.split(':')[1]
        users.push(userId)
      }
    }
  }

  return users
}

export function clearStaleTyping(): void {
  const now = Date.now()

  for (const [key, timestamp] of typingStates.entries()) {
    if (now - timestamp > 10000) {
      typingStates.delete(key)
    }
  }
}

// Start cleanup interval
setInterval(clearStaleTyping, 5000)
```

This handles:
- Store typing state per conversation/user
- 10-second timeout for stale indicators
- Cleanup interval runs every 5 seconds
  </action>
  <verify>Run: cd backend && npx tsc --noEmit</verify>
  <done>typingService.ts exports all functions, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 3: Add typing events to WebSocket handler</name>
  <files>backend/src/routes/websocket.ts</files>
  <action>
Import typingService and add typing message handling to existing WebSocket handler:

```typescript
import { handleTypingEvent, getTypingUsers } from '../services/typingService'
```

Add new message type handling in the message switch/if block:

```typescript
case 'typing':
  // { type: 'typing', conversationId: string, isTyping: boolean }
  handleTypingEvent(data.conversationId, userId, data.isTyping)

  // Broadcast to other participants
  // For DM: find recipient connection
  // For group: broadcast to all group members (except sender)
  const recipientConn = activeConnections.get(data.recipientId)
  if (recipientConn) {
    recipientConn.send(JSON.stringify({
      type: 'typing',
      conversationId: data.conversationId,
      userId: userId,
      isTyping: data.isTyping
    }))
  }
  break
```

Note: Group typing broadcasts will be enhanced in Plan 04 when group service exists.
For now, handle 1:1 conversation typing (recipientId in message).
  </action>
  <verify>Run: cd backend && npm run build (or npx tsc)</verify>
  <done>WebSocket handler processes typing events and broadcasts to recipients</done>
</task>

</tasks>

<verification>
1. Frontend npm ls shows all new dependencies installed
2. Backend compiles without TypeScript errors
3. typingService.ts exports handleTypingEvent, getTypingUsers, clearStaleTyping
4. websocket.ts imports and uses typingService
</verification>

<success_criteria>
- emoji-picker-react, yet-another-react-lightbox, @mediapipe/selfie_segmentation installed
- Typing indicator backend service created with timeout cleanup
- WebSocket handles typing events for 1:1 conversations
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-communication/05-02-SUMMARY.md`
</output>
