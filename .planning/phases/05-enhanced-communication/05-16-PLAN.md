---
phase: 05-enhanced-communication
plan: 16
type: execute
wave: 5
depends_on: ["05-11", "05-12", "05-13", "05-14", "05-15"]
files_modified:
  - frontend/src/components/messaging/MessageList.tsx
  - frontend/src/components/messaging/MessageInput.tsx
  - frontend/src/components/messaging/ConversationView.tsx
  - frontend/src/pages/GroupsPage.tsx
autonomous: false

must_haves:
  truths:
    - "Messages display reactions and reply quotes"
    - "Message input supports file attachments and replies"
    - "Group conversations page exists with group list"
    - "All Phase 5 success criteria verified"
  artifacts:
    - path: "frontend/src/pages/GroupsPage.tsx"
      provides: "Group conversation list page"
      exports: ["GroupsPage"]
    - path: "frontend/src/components/messaging/MessageList.tsx"
      provides: "Updated message list with reactions"
      contains: "ReactionList"
  key_links:
    - from: "MessageList.tsx"
      to: "InlineReactions"
      via: "import"
      pattern: "import.*InlineReactions"
    - from: "MessageInput.tsx"
      to: "FileUploadButton"
      via: "import"
      pattern: "import.*FileUploadButton"
---

<objective>
Integrate all Phase 5 components and verify success criteria.

Purpose: Complete feature integration and final verification
Output: Working Phase 5 features with verification checkpoint
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-enhanced-communication/05-RESEARCH.md
@.planning/phases/05-enhanced-communication/05-11-SUMMARY.md
@.planning/phases/05-enhanced-communication/05-12-SUMMARY.md
@.planning/phases/05-enhanced-communication/05-13-SUMMARY.md
@.planning/phases/05-enhanced-communication/05-14-SUMMARY.md
@.planning/phases/05-enhanced-communication/05-15-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MessageList with reactions and replies</name>
  <files>frontend/src/components/messaging/MessageList.tsx</files>
  <action>
Update MessageList.tsx to include reactions and reply display:

```typescript
// Add imports:
import { InlineReactions } from '@/components/reactions/ReactionList'
import { QuickReactions, MessageReactionOverlay } from '@/components/reactions/QuickReactions'
import { ReactionPickerTrigger } from '@/components/reactions/ReactionPicker'
import { MessageReply, ReplyButton } from '@/components/messaging/MessageReply'
import { useReactionStore } from '@/stores/reactionStore'
import { FilePreview } from '@/components/files/FilePreview'

// Add to message rendering:
// For each message, show:
// 1. Reply quote if message.reply_to_id exists
// 2. Message content
// 3. File attachments if any
// 4. Reactions list

{message.replyTo && (
  <MessageReply
    replyTo={{
      id: message.replyTo.id,
      content: message.replyTo.content,
      senderEmail: message.replyTo.senderEmail
    }}
    onClick={() => scrollToMessage(message.replyTo.id)}
  />
)}

<div className="message-content">{message.content}</div>

{message.files?.map(file => (
  <FilePreview
    key={file.id}
    fileId={file.id}
    filename={file.filename}
    mimeType={file.mimeType}
    sizeBytes={file.sizeBytes}
    onImageClick={() => openLightbox(file)}
  />
))}

<InlineReactions
  reactions={reactions.get(message.id) || []}
  onToggle={(emoji) => toggleReaction(message.id, emoji)}
/>

// Add hover overlay for quick reactions:
<MessageReactionOverlay
  messageId={message.id}
  onReact={(emoji) => toggleReaction(message.id, emoji)}
  show={hoveredMessageId === message.id}
/>
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>MessageList displays reactions, replies, and file attachments</done>
</task>

<task type="auto">
  <name>Task 2: Update MessageInput with files and replies</name>
  <files>frontend/src/components/messaging/MessageInput.tsx</files>
  <action>
Update MessageInput.tsx to support file attachments and replies:

```typescript
// Add imports:
import { FileUploadButton } from '@/components/files/FileUploader'
import { ReplyPreview } from '@/components/messaging/MessageReply'
import { useTypingIndicator } from '@/hooks/useTypingIndicator'
import { TypingIndicator } from '@/components/typing/TypingIndicator'

// Add state for reply:
const [replyTo, setReplyTo] = useState<{ id: number; content: string; senderEmail: string } | null>(null)

// Add typing indicator integration:
const { typingUsers, onInputChange, onMessageSend } = useTypingIndicator({
  conversationId,
  recipientId: contact?.id,
  sendTypingEvent: (isTyping) => sendTyping(conversationId, contact?.id, isTyping)
})

// Update input handler:
const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
  setMessage(e.target.value)
  onInputChange() // Trigger typing indicator
}

// Update send handler:
const handleSend = async () => {
  if (!message.trim() && files.length === 0) return

  onMessageSend() // Stop typing indicator

  await sendMessage({
    content: message,
    replyToId: replyTo?.id,
    fileIds: files.map(f => f.id)
  })

  setMessage('')
  setReplyTo(null)
  setFiles([])
}

// Add to JSX:
{replyTo && (
  <ReplyPreview
    replyTo={replyTo}
    onCancel={() => setReplyTo(null)}
  />
)}

<div className="flex items-end gap-2">
  <FileUploadButton
    onSelect={handleFileSelect}
  />

  <textarea
    value={message}
    onChange={handleChange}
    // ... existing props
  />

  <Button onClick={handleSend}>Send</Button>
</div>

<TypingIndicator users={typingUsers} className="mt-1" />
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>MessageInput supports files, replies, and shows typing indicator</done>
</task>

<task type="auto">
  <name>Task 3: Create GroupsPage</name>
  <files>frontend/src/pages/GroupsPage.tsx</files>
  <action>
Create GroupsPage.tsx:

```typescript
import { useState, useEffect } from 'react'
import { useGroupStore, Group } from '@/stores/groupStore'
import { GroupCreator } from '@/components/groups/GroupCreator'
import { GroupSettings } from '@/components/groups/GroupSettings'
import { MemberList } from '@/components/groups/MemberList'
import { ConversationView } from '@/components/messaging/ConversationView'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'

export function GroupsPage() {
  const [showCreator, setShowCreator] = useState(false)
  const [showSettings, setShowSettings] = useState(false)
  const [showMembers, setShowMembers] = useState(true)

  const groups = useGroupStore((s) => s.groups)
  const selectedGroupId = useGroupStore((s) => s.selectedGroupId)
  const loadGroups = useGroupStore((s) => s.loadGroups)
  const selectGroup = useGroupStore((s) => s.selectGroup)

  const selectedGroup = groups.find(g => g.id === selectedGroupId)

  useEffect(() => {
    loadGroups()
  }, [loadGroups])

  return (
    <div className="flex h-full">
      {/* Group list sidebar */}
      <div className="w-64 border-r border-gray-800 bg-gray-900 flex flex-col">
        <div className="p-4 border-b border-gray-800 flex items-center justify-between">
          <h2 className="font-semibold">Groups</h2>
          <Button size="sm" onClick={() => setShowCreator(true)}>
            + New
          </Button>
        </div>

        <div className="flex-1 overflow-y-auto">
          {groups.map((group) => (
            <button
              key={group.id}
              onClick={() => selectGroup(group.id)}
              className={cn(
                'w-full flex items-center gap-3 p-3 hover:bg-gray-800 transition-colors',
                selectedGroupId === group.id && 'bg-gray-800'
              )}
            >
              <Avatar>
                <AvatarFallback>{group.name.charAt(0)}</AvatarFallback>
              </Avatar>
              <div className="flex-1 min-w-0 text-left">
                <p className="font-medium truncate">{group.name}</p>
                <p className="text-xs text-gray-500">{group.member_count} members</p>
              </div>
            </button>
          ))}

          {groups.length === 0 && (
            <div className="p-4 text-center text-gray-500">
              <p>No groups yet</p>
              <Button variant="link" onClick={() => setShowCreator(true)}>
                Create your first group
              </Button>
            </div>
          )}
        </div>
      </div>

      {/* Main content */}
      <div className="flex-1 flex">
        {selectedGroup ? (
          <>
            {/* Conversation view */}
            <div className="flex-1 flex flex-col">
              <div className="p-4 border-b border-gray-800 flex items-center justify-between">
                <div>
                  <h2 className="font-semibold">{selectedGroup.name}</h2>
                  {selectedGroup.description && (
                    <p className="text-sm text-gray-500">{selectedGroup.description}</p>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setShowMembers(!showMembers)}
                    className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded"
                    title="Toggle members"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </button>
                  <button
                    onClick={() => setShowSettings(true)}
                    className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded"
                    title="Group settings"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </button>
                </div>
              </div>

              {/* Group conversation - reuse existing component */}
              <ConversationView
                conversationId={selectedGroup.id}
                isGroup={true}
              />
            </div>

            {/* Member list sidebar */}
            {showMembers && (
              <MemberList
                groupId={selectedGroup.id}
                onToggle={() => setShowMembers(false)}
              />
            )}
          </>
        ) : (
          <div className="flex-1 flex items-center justify-center text-gray-500">
            Select a group or create a new one
          </div>
        )}
      </div>

      {/* Modals */}
      {showCreator && (
        <GroupCreator
          onClose={() => setShowCreator(false)}
          onCreated={(groupId) => selectGroup(groupId)}
        />
      )}

      {showSettings && selectedGroup && (
        <GroupSettings
          group={selectedGroup}
          onClose={() => setShowSettings(false)}
        />
      )}
    </div>
  )
}
```
  </action>
  <verify>Run: cd frontend && npx tsc --noEmit</verify>
  <done>GroupsPage provides group list and conversation view</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    All Phase 5 features integrated:
    - Video calls with camera toggle
    - Group conversations with member management
    - File sharing with encryption
    - Emoji reactions on messages
    - Typing indicators
  </what-built>
  <how-to-verify>
    1. Start the application (docker compose up)
    2. Login with two test accounts in separate browsers

    **Video Calls:**
    - Start a call between accounts
    - Toggle camera on - verify video preview appears
    - Verify remote party sees your video
    - Toggle blur (Chrome/Edge only)
    - Change quality in settings

    **Group Conversations:**
    - Create a new group with name and description
    - Add another user to the group
    - Send messages in group
    - View member list sidebar
    - Try changing member roles (as owner)
    - Create and copy invite link

    **File Sharing:**
    - Click attach button in message input
    - Select an image file
    - Verify upload progress shows
    - Verify image displays inline
    - Click image to open lightbox with zoom
    - Upload a non-image file and verify download works

    **Reactions:**
    - Hover over a message
    - Click a quick reaction emoji
    - Verify reaction appears below message
    - Click same reaction to toggle off
    - Click + to open full emoji picker
    - Add a reaction from picker
    - Hover reaction to see user list

    **Typing Indicators:**
    - Start typing in conversation
    - Verify other party sees "Name is typing..."
    - Stop typing, wait 5 seconds
    - Verify indicator disappears
    - Send message - verify indicator stops immediately
  </how-to-verify>
  <resume-signal>
    Type "verified" if all features work correctly.
    Describe any issues found for gap closure.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 5 Success Criteria from ROADMAP.md:
1. User can make video calls with camera feed
2. User can create group conversations with multiple participants
3. User can share files and images in conversations
4. User can react to messages with emoji
5. User sees typing indicators when contact is composing
</verification>

<success_criteria>
All five Phase 5 success criteria verified by human tester.
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-communication/05-16-SUMMARY.md`
</output>
