---
phase: 03-voice-video-calls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - .env.example
  - backend/src/services/turnService.ts
  - backend/src/routes/turn.ts
  - backend/src/server.ts
autonomous: true

must_haves:
  truths:
    - "Coturn container starts and accepts connections on ports 3478/5349"
    - "Backend can generate time-limited TURN credentials"
    - "Frontend can request TURN credentials via REST API"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Coturn service definition with environment config"
      contains: "coturn"
    - path: "backend/src/services/turnService.ts"
      provides: "HMAC-SHA1 credential generation"
      exports: ["generateTurnCredentials"]
    - path: "backend/src/routes/turn.ts"
      provides: "REST endpoint for credentials"
      exports: ["default"]
  key_links:
    - from: "backend/src/routes/turn.ts"
      to: "backend/src/services/turnService.ts"
      via: "import generateTurnCredentials"
      pattern: "generateTurnCredentials"
    - from: "backend/src/server.ts"
      to: "backend/src/routes/turn.ts"
      via: "fastify.register"
      pattern: "register.*turnRoutes"
---

<objective>
Set up coturn TURN/STUN server in Docker and create backend service for generating time-limited TURN credentials using REST API authentication pattern.

Purpose: Enables NAT traversal for WebRTC calls. Users behind firewalls need TURN relay to establish connections. Self-hosted coturn with dynamic credentials ensures privacy and prevents credential abuse.

Output: Running coturn container, turnService with HMAC-SHA1 credential generation, authenticated REST endpoint for credential retrieval.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-video-calls/03-CONTEXT.md
@.planning/phases/03-voice-video-calls/03-RESEARCH.md

# Existing infrastructure
@docker-compose.yml
@backend/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coturn service to Docker Compose</name>
  <files>docker-compose.yml, .env.example</files>
  <action>
Add coturn/coturn:4.6.3 service to docker-compose.yml with:
- Ports: 3478:3478 (UDP+TCP), 5349:5349 (TLS), 49152-49200:49152-49200/udp (media relay range - limited to avoid Docker slowdown)
- Environment: TURN_SECRET from env, realm from env
- Network mode: default (not host - we're behind nginx)
- Configuration via command line args (--no-cli, --no-tls for v1, --use-auth-secret, --static-auth-secret, --realm)
- Healthcheck: nc -z localhost 3478

Add to .env.example:
- TURN_SECRET (generate placeholder: use `openssl rand -hex 32`)
- TURN_REALM (default: the docker host)

Note: For production, TURN_REALM should match the domain. For development, localhost works.
  </action>
  <verify>Run `docker compose config` to validate YAML. Check coturn service is defined with correct ports and environment.</verify>
  <done>Coturn service configured in docker-compose.yml with REST API auth secret and appropriate port mappings</done>
</task>

<task type="auto">
  <name>Task 2: Create TURN credentials service</name>
  <files>backend/src/services/turnService.ts</files>
  <action>
Create turnService.ts implementing RFC-style TURN REST API credential generation:

```typescript
interface TurnCredentials {
  username: string;    // Format: "{expiry_timestamp}:{userId}"
  password: string;    // HMAC-SHA1(secret, username) base64 encoded
  ttl: number;         // Time-to-live in seconds
  uris: string[];      // TURN server URIs
}

function generateTurnCredentials(userId: string, ttl: number = 86400): TurnCredentials
```

Implementation:
1. Read TURN_SECRET and TURN_REALM from process.env
2. Calculate expiry timestamp: Math.floor(Date.now() / 1000) + ttl
3. Create username: `${timestamp}:${userId}`
4. Generate password: crypto.createHmac('sha1', secret).update(username).digest('base64')
5. Return credentials with URIs:
   - `turn:${process.env.TURN_HOST || 'localhost'}:3478?transport=udp`
   - `turn:${process.env.TURN_HOST || 'localhost'}:3478?transport=tcp`

Add TURN_HOST to .env.example (defaults to localhost for dev, should be public IP/domain in prod).

TTL of 24 hours (86400s) ensures credentials outlast any reasonable call duration.
  </action>
  <verify>Import and call generateTurnCredentials in a test file or via ts-node to verify it returns properly formatted credentials.</verify>
  <done>turnService exports generateTurnCredentials function that creates time-limited HMAC credentials</done>
</task>

<task type="auto">
  <name>Task 3: Create TURN credentials REST endpoint</name>
  <files>backend/src/routes/turn.ts, backend/src/server.ts</files>
  <action>
Create turn.ts route with:
- GET /api/turn/credentials (authenticated via JWT)
- Uses fastify.authenticate decorator (same pattern as other protected routes)
- Calls generateTurnCredentials with userId from request.user
- Returns JSON with username, password, ttl, uris

Register route in server.ts:
- Import turnRoutes from './routes/turn.js'
- Register at /api/turn prefix

The endpoint requires authentication because TURN credentials should only be issued to logged-in users.
  </action>
  <verify>Start backend, authenticate, then `curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/turn/credentials` should return valid credentials JSON.</verify>
  <done>GET /api/turn/credentials returns time-limited TURN credentials for authenticated users</done>
</task>

</tasks>

<verification>
1. `docker compose up -d coturn` starts coturn container
2. `docker compose logs coturn` shows no errors
3. Backend starts without errors with new turnService
4. Authenticated request to /api/turn/credentials returns valid credentials structure
5. Credentials contain proper TURN URIs and HMAC-generated password
</verification>

<success_criteria>
- Coturn container running and healthy in Docker
- TURN credentials endpoint returns properly formatted credentials
- Credentials use time-limited HMAC authentication (not static)
- All environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-video-calls/03-01-SUMMARY.md`
</output>
