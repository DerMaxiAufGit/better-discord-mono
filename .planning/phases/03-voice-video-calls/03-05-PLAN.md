---
phase: 03-voice-video-calls
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - frontend/src/lib/webrtc/useCall.ts
  - frontend/src/components/call/CallControls.tsx
  - frontend/src/components/call/IncomingCallBanner.tsx
  - frontend/src/components/call/ActiveCallWindow.tsx
  - frontend/src/components/call/CallQualityIndicator.tsx
  - frontend/src/components/call/CallTimer.tsx
autonomous: true

must_haves:
  truths:
    - "User sees incoming call notification at top of screen"
    - "User can accept or decline incoming call"
    - "User can mute/unmute during active call"
    - "User sees call quality indicator during call"
    - "User sees call duration timer during call"
  artifacts:
    - path: "frontend/src/lib/webrtc/useCall.ts"
      provides: "Call orchestration hook"
      exports: ["useCall"]
      min_lines: 200
    - path: "frontend/src/components/call/CallControls.tsx"
      provides: "Mute, speaker, end call buttons"
      exports: ["CallControls"]
    - path: "frontend/src/components/call/IncomingCallBanner.tsx"
      provides: "Top-of-screen call notification"
      exports: ["IncomingCallBanner"]
    - path: "frontend/src/components/call/ActiveCallWindow.tsx"
      provides: "Full page and floating call UI"
      exports: ["ActiveCallWindow"]
  key_links:
    - from: "frontend/src/lib/webrtc/useCall.ts"
      to: "frontend/src/stores/callStore.ts"
      via: "import useCallStore"
      pattern: "useCallStore"
    - from: "frontend/src/lib/webrtc/useCall.ts"
      to: "frontend/src/lib/webrtc/PeerConnection.ts"
      via: "import PeerConnectionManager"
      pattern: "PeerConnectionManager|createPeerConnection"
---

<objective>
Create the main call orchestration hook (useCall) and all call-related UI components: incoming call banner, active call window with controls, quality indicator, and timer.

Purpose: Provides the complete calling experience from receiving notifications to active call management. The useCall hook coordinates WebRTC, signaling, and call store state. UI components render based on call state.

Output: Fully functional call UI with mute, end call, quality display, and minimize/maximize capability.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-video-calls/03-CONTEXT.md
@.planning/phases/03-voice-video-calls/03-RESEARCH.md
@.planning/phases/03-voice-video-calls/03-02-SUMMARY.md
@.planning/phases/03-voice-video-calls/03-03-SUMMARY.md
@.planning/phases/03-voice-video-calls/03-04-SUMMARY.md

# Existing components for patterns
@frontend/src/components/ui/button.tsx
@frontend/src/components/ui/avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCall orchestration hook</name>
  <files>frontend/src/lib/webrtc/useCall.ts</files>
  <action>
Create useCall.ts as the main call orchestration hook:

```typescript
interface UseCallReturn {
  // State (from callStore)
  status: CallStatus;
  remoteUsername: string | null;
  isMuted: boolean;
  quality: 1 | 2 | 3 | 4;
  latency: number | null;
  isMinimized: boolean;

  // Actions
  startCall: (userId: string, username: string) => Promise<void>;
  acceptCall: () => Promise<void>;
  rejectCall: () => void;
  hangup: () => void;
  toggleMute: () => void;
  toggleMinimized: () => void;
}

export function useCall(): UseCallReturn
```

Implementation:
1. Access callStore for state and actions
2. Access settingsStore for audio preferences
3. Create refs for PeerConnectionManager, local/remote MediaStream, quality polling interval

startCall:
- Generate callId (uuid or timestamp-based)
- Determine polite role (lexicographic comparison of user IDs - same as key exchange)
- Get audio stream with useAudioDevices' getAudioStream
- Create PeerConnection
- Send call-offer via WebSocket
- Update callStore to 'outgoing'
- Set ring timeout (from settingsStore.ringTimeout)

Handle incoming WebSocket messages (via custom event or integration with useMessaging):
- call-offer: Update callStore to 'incoming', store remote SDP
- call-accept: Start PeerConnection negotiation
- call-answer: Handle via PeerConnection's handleRemoteDescription
- call-ice-candidate: Handle via PeerConnection
- call-reject: End call, show "Call declined"
- call-hangup: End call

Quality monitoring:
- Poll pc.getStats() every 1000ms during connected state
- Parse inbound-rtp for packet loss, jitter
- Parse candidate-pair for RTT
- Calculate quality level (1-4 bars)
- Update callStore quality/latency

Cleanup on hangup:
- Stop all local tracks
- Close PeerConnection
- Clear intervals
- Reset callStore
  </action>
  <verify>Import useCall in a test component, call startCall with a valid user, verify call-offer is sent via WebSocket and callStore updates to 'outgoing'.</verify>
  <done>useCall orchestrates entire call lifecycle from start to end</done>
</task>

<task type="auto">
  <name>Task 2: Create call UI components</name>
  <files>frontend/src/components/call/CallControls.tsx, frontend/src/components/call/IncomingCallBanner.tsx, frontend/src/components/call/ActiveCallWindow.tsx, frontend/src/components/call/CallQualityIndicator.tsx, frontend/src/components/call/CallTimer.tsx</files>
  <action>
Create call UI components:

**CallControls.tsx:**
```typescript
interface CallControlsProps {
  isMuted: boolean;
  onToggleMute: () => void;
  onHangup: () => void;
  micLevel?: number;           // For activity indicator
}
```
- Mute button with mic icon (filled when muted, outline when active)
- Mic activity pulse when micLevel > threshold
- End call button (red, phone-down icon)
- Keyboard shortcuts: Space = mute, Escape = hangup
- Use lucide-react icons (Mic, MicOff, PhoneOff)

**IncomingCallBanner.tsx:**
```typescript
interface IncomingCallBannerProps {
  callerUsername: string;
  onAccept: () => void;
  onReject: () => void;
  ringTimeout: number;         // Show countdown
}
```
- Fixed position at top of screen (z-50)
- Avatar, caller name, "Incoming call..."
- Accept (green) and Reject (red) buttons
- Countdown timer to auto-reject
- Subtle animation (pulse or slide-in)

**ActiveCallWindow.tsx:**
```typescript
interface ActiveCallWindowProps {
  remoteUsername: string;
  status: CallStatus;
  isMuted: boolean;
  quality: 1 | 2 | 3 | 4;
  latency: number | null;
  isMinimized: boolean;
  startTime: Date | null;
  onToggleMute: () => void;
  onHangup: () => void;
  onToggleMinimized: () => void;
  micLevel?: number;
}
```
- Full page view (default): centered avatar, name, status, controls at bottom
- Floating view (minimized): small draggable window in corner (position fixed)
- Show reconnecting state with spinner
- Include CallQualityIndicator and CallTimer

**CallQualityIndicator.tsx:**
- Signal bars (1-4) with color coding
- Green (4, 3), Yellow (2), Red (1)
- Optional latency display (e.g., "45ms")

**CallTimer.tsx:**
- Display elapsed time since startTime
- Format: MM:SS or HH:MM:SS if over an hour
- Update every second
  </action>
  <verify>Render each component with mock props, verify they display correctly. Test keyboard shortcuts in CallControls.</verify>
  <done>All call UI components render correctly with proper styling and interactions</done>
</task>

</tasks>

<verification>
1. useCall can start outgoing call and sends proper signaling
2. Incoming call shows IncomingCallBanner
3. CallControls mute button toggles and shows activity
4. Keyboard shortcuts work (Space, Escape)
5. Quality indicator shows correct color for each level
6. Timer counts up during active call
7. Minimized view is draggable and positioned correctly
</verification>

<success_criteria>
- Complete call flow works: start -> ring -> connect -> talk -> hangup
- All UI states rendered correctly (outgoing, incoming, connecting, connected, reconnecting)
- Quality monitoring updates during call
- Keyboard shortcuts functional
- Clean UI matching existing shadcn/Tailwind patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-video-calls/03-05-SUMMARY.md`
</output>
