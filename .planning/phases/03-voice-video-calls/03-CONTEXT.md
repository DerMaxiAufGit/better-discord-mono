# Phase 3: Voice/Video Calls - Context

**Gathered:** 2026-01-28
**Status:** Ready for planning

<domain>
## Phase Boundary

Real-time peer-to-peer voice calls between friends using WebRTC. Includes call initiation, accept/decline flow, in-call controls, NAT traversal via self-hosted TURN, and connection quality feedback. Video calls are deferred to a later phase.

</domain>

<decisions>
## Implementation Decisions

### Call Initiation & UI
- Call buttons available in BOTH chat header AND contact profile
- Incoming calls: banner notification (top of screen, doesn't interrupt current view)
- Active call: full page by default, can minimize to floating draggable window
- In-call controls: mute, speaker/output toggle, end call (no video toggle until video phase)
- Ringtone: user preference in settings (enable/disable)
- Ring timeout: configurable in settings, default 30 seconds
- Call end: show call summary (duration) before returning
- Missed calls: appear as system message in chat history

### NAT Traversal Strategy
- Self-host coturn in Docker (full self-hosting, no external services)
- Connection strategy: try direct P2P first, fall back to TURN relay if needed
- TURN authentication: time-limited tokens generated by backend (not static)
- No public STUN fallback (privacy-first, self-hosted only)

### Media Scope
- Voice only in Phase 3 (video deferred to later phase)
- Hide video toggle button until video is implemented (only show working controls)
- Audio device selection: both input (mic) AND output (speakers) selectable during call
- Audio processing: echo cancellation and noise suppression available, toggle in settings
- Mic test feature in audio settings (hear yourself)
- Mic activity indicator: simple pulse on mic icon when detecting audio
- Keyboard shortcuts: Space to mute/unmute, Escape to end call
- Browser permissions: request mic permission in settings/setup flow (not on first call)

### Call Quality & Feedback
- Quality indicator: signal bars (1-4) with color coding (green/yellow/red)
- Poor connection: visual warning + auto-reconnect when interrupted
- Call timer: always visible during call
- Reconnecting state: show "Reconnecting..." with timeout countdown

### Claude's Discretion
- Exact reconnect timeout duration
- Floating window dimensions and positioning
- Call summary screen layout
- Signal bar thresholds for quality levels
- Audio processing defaults (on or off initially)

</decisions>

<specifics>
## Specific Ideas

- Ring timeout and ringtone both configurable in user settings
- Full self-hosting philosophy maintained - no external STUN/TURN services
- Privacy-first: all call infrastructure self-contained
- Future-ready architecture but no incomplete features shown to users

</specifics>

<deferred>
## Deferred Ideas

- Video calls - separate phase after voice is solid
- Screen sharing - future enhancement
- Group calls - out of scope for 1:1 focused app
- Call recording - privacy concerns, not planned

</deferred>

---

*Phase: 03-voice-video-calls*
*Context gathered: 2026-01-28*
