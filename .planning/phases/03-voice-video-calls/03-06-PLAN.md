---
phase: 03-voice-video-calls
plan: 06
type: execute
wave: 4
depends_on: ["03-04", "03-05"]
files_modified:
  - frontend/src/pages/SettingsPage.tsx
  - frontend/src/components/settings/AudioSettings.tsx
autonomous: true

must_haves:
  truths:
    - "User can select microphone from available devices"
    - "User can select speaker/output device"
    - "User can test microphone and hear playback"
    - "User can toggle audio processing settings"
  artifacts:
    - path: "frontend/src/pages/SettingsPage.tsx"
      provides: "Audio settings section in settings page"
      contains: "AudioSettings"
    - path: "frontend/src/components/settings/AudioSettings.tsx"
      provides: "Audio device selection and test UI"
      exports: ["AudioSettings"]
      min_lines: 100
  key_links:
    - from: "frontend/src/components/settings/AudioSettings.tsx"
      to: "frontend/src/lib/webrtc/useAudioDevices.ts"
      via: "import useAudioDevices"
      pattern: "useAudioDevices"
    - from: "frontend/src/components/settings/AudioSettings.tsx"
      to: "frontend/src/stores/settingsStore.ts"
      via: "import useSettingsStore"
      pattern: "useSettingsStore"
---

<objective>
Add audio settings section to SettingsPage with device selection, microphone test feature, and audio processing toggles.

Purpose: Enable users to configure their audio devices and test microphone before making calls. Per CONTEXT.md, microphone permission should be requested in settings/setup flow rather than on first call to avoid surprise permission prompts.

Output: AudioSettings component with device dropdowns, mic test with playback, processing toggles, integrated into SettingsPage.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-video-calls/03-CONTEXT.md
@.planning/phases/03-voice-video-calls/03-04-SUMMARY.md
@.planning/phases/03-voice-video-calls/03-05-SUMMARY.md

# Existing settings page
@frontend/src/pages/SettingsPage.tsx
@frontend/src/stores/settingsStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AudioSettings component</name>
  <files>frontend/src/components/settings/AudioSettings.tsx</files>
  <action>
Create AudioSettings.tsx with:

```typescript
export function AudioSettings()
```

**Device Selection:**
- Microphone dropdown (from useAudioDevices inputs)
- Speaker dropdown (from useAudioDevices outputs)
- "System Default" as first option for each
- Show permission request button if permission not granted
- Reload devices button if needed

**Microphone Test:**
- "Test Microphone" button to start
- Visual level meter (bar that moves with voice)
- "Hear Yourself" toggle (loops audio back - caution for echo)
- Stop test button

Implementation for mic test:
1. Get audio stream with selected device
2. Use useAudioLevel to show level meter
3. For "hear yourself": connect stream to audio element with setSinkId to selected speaker
4. Cleanup stream on stop or unmount

**Audio Processing Toggles:**
- Echo cancellation (switch)
- Noise suppression (switch)
- Auto gain control (switch)
All toggles update settingsStore immediately

**Call Preferences:**
- Ringtone enabled (switch)
- Ring timeout (number input, 10-60 seconds)

Use shadcn-style components:
- Select dropdowns (can use native select with Tailwind styling)
- Switch toggles (styled checkboxes or custom)
- Button for actions

Handle edge cases:
- Show "No microphones found" if inputs empty
- Show "Grant permission to see device names" if labels are empty
- Disable speaker selection if browser doesn't support setSinkId
  </action>
  <verify>Render AudioSettings, grant mic permission, verify device dropdowns populate. Test mic test feature - level meter should respond to voice.</verify>
  <done>AudioSettings provides complete audio configuration UI</done>
</task>

<task type="auto">
  <name>Task 2: Integrate AudioSettings into SettingsPage</name>
  <files>frontend/src/pages/SettingsPage.tsx</files>
  <action>
Add Audio section to SettingsPage after Appearance section:

```tsx
import { AudioSettings } from '@/components/settings/AudioSettings';

// In the settings sections:
{/* Audio Section */}
<section className="space-y-4">
  <h2 className="text-lg font-semibold">Audio</h2>
  <AudioSettings />
</section>
```

Place between Appearance and any future sections.

Add icon imports if using section icons (Mic from lucide-react).
  </action>
  <verify>Navigate to /settings, verify Audio section appears with all controls. Test device selection updates settingsStore.</verify>
  <done>SettingsPage includes Audio section with full device configuration</done>
</task>

</tasks>

<verification>
1. Audio section visible in SettingsPage
2. Device dropdowns show available microphones and speakers
3. Selecting a device updates settingsStore
4. Mic test shows real-time level visualization
5. "Hear yourself" feature works (with echo warning)
6. Processing toggles persist across page refresh
7. Ring timeout and ringtone settings save correctly
</verification>

<success_criteria>
- Users can fully configure audio before making calls
- Microphone permission requested via settings (not during call)
- Device selections persist across sessions
- Mic test provides confidence that audio works
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-video-calls/03-06-SUMMARY.md`
</output>
